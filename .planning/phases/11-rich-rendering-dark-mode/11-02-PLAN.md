---
phase: 11-rich-rendering-dark-mode
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/chat/code-block.tsx
  - components/chat/message-content.tsx
autonomous: true

must_haves:
  truths:
    - "AI responses render markdown headers, lists, bold, italic, links, and tables"
    - "Code blocks display with syntax highlighting and a copy button"
    - "Markdown rendering is XSS-safe: javascript: links are blocked, HTML is sanitized"
    - "Inline code renders with distinct styling"
  artifacts:
    - path: "components/chat/code-block.tsx"
      provides: "Syntax-highlighted code block with copy button"
      contains: "SyntaxHighlighter"
      min_lines: 30
    - path: "components/chat/message-content.tsx"
      provides: "Markdown renderer replacing custom regex formatter"
      contains: "ReactMarkdown"
      min_lines: 30
  key_links:
    - from: "components/chat/message-content.tsx"
      to: "components/chat/code-block.tsx"
      via: "import CodeBlock, used in components.code override"
      pattern: "CodeBlock"
    - from: "components/chat/message-content.tsx"
      to: "rehype-sanitize"
      via: "rehypePlugins array"
      pattern: "rehypeSanitize"
    - from: "components/chat/message-content.tsx"
      to: "remark-gfm"
      via: "remarkPlugins array"
      pattern: "remarkGfm"
---

<objective>
Replace the custom regex-based message formatter with a secure, full-featured markdown renderer.

Purpose: AI responses currently only handle bold, italic, inline code, and lists via fragile regex parsing. This plan adds proper markdown rendering with GFM tables, syntax-highlighted code blocks with copy-to-clipboard, and XSS sanitization.
Output: CodeBlock component and fully rewritten MessageContent component using react-markdown.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-rich-rendering-dark-mode/11-RESEARCH.md
@components/chat/message-content.tsx
@components/chat/telegram-chat-v2.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CodeBlock component with syntax highlighting and copy button</name>
  <files>components/chat/code-block.tsx</files>
  <action>
Create `components/chat/code-block.tsx` as a 'use client' component:

1. **Imports** (use `/dist/cjs/` paths for Next.js compatibility -- ESM paths cause build failures):
   - `Prism as SyntaxHighlighter` from `react-syntax-highlighter/dist/cjs/prism`
   - `vscDarkPlus` from `react-syntax-highlighter/dist/cjs/styles/prism/vsc-dark-plus`
   - `vs` from `react-syntax-highlighter/dist/cjs/styles/prism/vs`
   - `useTheme` from `next-themes`
   - `useState` from `react`

2. **Props**: `{ language: string; value: string }`

3. **Theme awareness**:
   - Use `useTheme()` to get `resolvedTheme` (NOT `theme` -- `resolvedTheme` gives actual applied theme even when set to "system")
   - Select `vscDarkPlus` when resolvedTheme === 'dark', `vs` otherwise
   - No mounted guard needed here because SyntaxHighlighter uses inline styles that work regardless

4. **Copy button**:
   - State: `copied` boolean, reset after 2 seconds via setTimeout
   - Use `navigator.clipboard.writeText(value)` wrapped in try-catch
   - Position: absolute top-right of code block container
   - Show "Copy" by default, "Copied!" for 2 seconds after click
   - Visible on hover via group/group-hover pattern (always visible on mobile via touch)
   - Styling: small, semi-transparent background, does not overlap code content
   - Include `aria-label="Copy code"` for accessibility

5. **Language label**:
   - Show language name in top-left corner (e.g., "typescript", "python")
   - Small text, muted color

6. **Layout**:
   - Outer div with `relative group my-4 rounded-lg overflow-hidden` and appropriate border
   - Header bar with language label and copy button
   - SyntaxHighlighter with `customStyle={{ margin: 0, fontSize: '0.875rem', padding: '1rem' }}`
   - Use `showLineNumbers={false}` to keep it clean
   - `wrapLongLines={true}` to prevent horizontal scroll on mobile

Note: The component receives `value` already stripped of trailing newline (done by MessageContent).
  </action>
  <verify>
File exists at `components/chat/code-block.tsx`. Contains imports from `/dist/cjs/` paths. Has copy button with clipboard API. Uses `resolvedTheme` from useTheme.
  </verify>
  <done>
CodeBlock component renders syntax-highlighted code with language label, copy button, and theme-aware styling. Uses Prism via react-syntax-highlighter with CJS imports for Next.js compatibility.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace MessageContent with react-markdown renderer</name>
  <files>components/chat/message-content.tsx</files>
  <action>
Completely rewrite `components/chat/message-content.tsx`:

1. **Interface change**: The current component takes `{ content: string; textColor: string }`. The new component should take `{ content: string; isUser?: boolean }`. The `textColor` prop is being removed because colors will come from Tailwind/CSS variables (dark mode compatible). The `isUser` prop is needed to conditionally disable markdown rendering for user messages (users don't write markdown, and rendering their text as markdown causes issues with asterisks, underscores, etc.).

2. **User messages**: If `isUser` is true, render content as plain text with `whitespace-pre-wrap` -- no markdown processing. This matches how ChatGPT/Claude handle user messages.

3. **AI messages (isUser=false or undefined)**: Render with ReactMarkdown:
   - Import `ReactMarkdown` from `react-markdown`
   - Import `remarkGfm` from `remark-gfm` (tables, strikethrough, task lists)
   - Import `rehypeSanitize` from `rehype-sanitize` (XSS prevention)
   - Import `CodeBlock` from `./code-block`

4. **ReactMarkdown wrapper**:
   - `className="prose prose-sm dark:prose-invert max-w-none"` for typography defaults
   - `remarkPlugins={[remarkGfm]}`
   - `rehypePlugins={[rehypeSanitize]}`

5. **Custom components override** (pass to `components` prop):
   - **code**: Detect fenced code blocks vs inline code. Fenced blocks have `className` starting with "language-". For fenced blocks, extract language from className via regex `/language-(\w+)/` and render `<CodeBlock language={match} value={children} />`. For inline code, render `<code className="bg-black/10 dark:bg-white/10 px-1.5 py-0.5 rounded text-xs font-mono">`.
   - **a (links)**: Block `javascript:` protocol links (render just the text, no link). For safe links, render with `target="_blank" rel="noopener noreferrer"` and styled in orange: `className="text-primary hover:underline"`.
   - **p**: Add `className="mb-2 last:mb-0"` for paragraph spacing.
   - **table**: Add `className="border-collapse w-full my-2"` and wrap in overflow-x-auto div for mobile.
   - **th**: Add `className="border border-border px-3 py-1 text-left bg-muted/50 text-sm font-semibold"`.
   - **td**: Add `className="border border-border px-3 py-1 text-sm"`.
   - **pre**: Render just `{children}` without wrapping `<pre>` tag (CodeBlock handles its own container).

6. **Outer wrapper**:
   - `className="text-sm leading-relaxed break-words overflow-hidden [&_ul]:list-disc [&_ul]:pl-5 [&_ol]:list-decimal [&_ol]:pl-5 [&_li]:mb-1"`
   - Use `style={{ wordBreak: 'break-word', overflowWrap: 'anywhere' }}` for long URLs
   - Note: DO NOT pass inline `style={{ color: ... }}` -- let Tailwind prose/dark:prose-invert handle text colors

IMPORTANT: The `textColor` prop removal means telegram-chat-v2.tsx (which passes textColor) will need updating in Plan 03. This component should NOT accept textColor anymore.
  </action>
  <verify>
File exists at `components/chat/message-content.tsx`. Contains `ReactMarkdown`, `remarkGfm`, `rehypeSanitize` imports. Has `code` component override that renders CodeBlock for fenced blocks. Has `a` component override that blocks javascript: links. Does NOT contain the old regex-based `formatText` or `formatInlineText` functions.
  </verify>
  <done>
MessageContent renders AI responses as full markdown with GFM tables, syntax-highlighted code blocks, and XSS sanitization. User messages render as plain text. Old regex-based formatter is completely removed.
  </done>
</task>

</tasks>

<verification>
1. `components/chat/code-block.tsx` exists with Prism syntax highlighter and copy button
2. `components/chat/message-content.tsx` uses ReactMarkdown with remarkGfm and rehypeSanitize
3. Old regex formatter functions (formatText, formatInlineText) are completely gone
4. Code blocks use CJS import paths (`/dist/cjs/`) for Next.js build compatibility
5. XSS vectors blocked: javascript: links filtered in `a` component, rehypeSanitize strips event handlers and script tags
</verification>

<success_criteria>
- AI responses render headers (h1-h6), lists (ul/ol), bold, italic, links, and tables
- Code blocks show syntax highlighting with language label and working copy button
- Inline code has distinct background styling
- javascript: links are rendered as plain text (not clickable)
- User messages render as plain text without markdown processing
</success_criteria>

<output>
After completion, create `.planning/phases/11-rich-rendering-dark-mode/11-02-SUMMARY.md`
</output>
