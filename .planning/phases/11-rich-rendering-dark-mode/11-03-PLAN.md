---
phase: 11-rich-rendering-dark-mode
plan: 03
type: execute
wave: 2
depends_on: ["11-01", "11-02"]
files_modified:
  - components/chat/telegram-chat-v2.tsx
  - app/chat/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle between dark and light themes via visible control in chat header"
    - "Theme persists across page refreshes"
    - "No UI element has invisible text, broken contrast, or unreadable content in either theme"
    - "Chat loading screen works in both themes"
    - "Settings modal works in both themes"
  artifacts:
    - path: "components/chat/telegram-chat-v2.tsx"
      provides: "Chat component using Tailwind theme classes instead of hardcoded hex colors"
      contains: "useTheme"
    - path: "app/chat/page.tsx"
      provides: "Chat page with theme-aware loading, settings, and status indicators"
      contains: "dark:"
  key_links:
    - from: "components/chat/telegram-chat-v2.tsx"
      to: "next-themes"
      via: "useTheme hook for theme toggle"
      pattern: "useTheme"
    - from: "components/chat/telegram-chat-v2.tsx"
      to: "components/chat/message-content.tsx"
      via: "passes isUser prop instead of textColor"
      pattern: "isUser"
    - from: "components/chat/telegram-chat-v2.tsx"
      to: "Tailwind CSS variables"
      via: "bg-background, text-foreground, border-border etc."
      pattern: "bg-background|text-foreground|border-border"
---

<objective>
Replace all hardcoded theme colors in the chat UI with Tailwind CSS variable classes and wire the theme toggle to next-themes.

Purpose: The chat component currently has a local `themes` object with hardcoded hex colors (`#0a0a0a`, `#FAFAFA`, etc.) and its own `isDark` state. This must be replaced with Tailwind's CSS variable system so colors automatically respond to the global theme set by next-themes ThemeProvider.
Output: telegram-chat-v2.tsx and chat/page.tsx using Tailwind theme classes throughout, with theme toggle wired to next-themes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-rich-rendering-dark-mode/11-RESEARCH.md
@.planning/phases/11-rich-rendering-dark-mode/11-01-SUMMARY.md
@.planning/phases/11-rich-rendering-dark-mode/11-02-SUMMARY.md
@components/chat/telegram-chat-v2.tsx
@app/chat/page.tsx
@app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded theme system in telegram-chat-v2.tsx</name>
  <files>components/chat/telegram-chat-v2.tsx</files>
  <action>
Major refactor of telegram-chat-v2.tsx to remove the local theme system and use Tailwind CSS variables:

**1. Remove the hardcoded themes object** (lines ~28-57 with `themes.light` and `themes.dark`). This entire object goes away.

**2. Remove local theme state**:
- Remove `const [isDark, setIsDark] = useState(defaultDarkMode)` and the `useEffect` that checks system preference -- next-themes handles all of this now.
- Remove `const theme = isDark ? themes.dark : themes.light` -- no longer needed.
- Remove `defaultDarkMode` from TelegramChatV2Props interface.

**3. Add next-themes integration**:
- Import `useTheme` from `next-themes`
- Import `useState, useEffect` for mounted guard
- Add mounted guard: `const [mounted, setMounted] = useState(false); useEffect(() => setMounted(true), []); ` -- needed for theme toggle button to avoid hydration mismatch
- Get `{ theme, setTheme, resolvedTheme }` from `useTheme()`

**4. Replace all inline `style={{ backgroundColor: theme.xxx }}` with Tailwind classes**:

Mapping (old -> new):
- `theme.background` -> `bg-background` class
- `theme.navBg` -> `bg-card` class (card is slightly elevated surface)
- `theme.navBorder` -> `border-border` class
- `theme.textPrimary` -> `text-foreground` class
- `theme.textSecondary` -> `text-muted-foreground` class
- `theme.inputBg` -> `bg-card` class
- `theme.inputBorder` -> `border-border` class (or `border-input`)
- `theme.accent` / `theme.senderBubble` -> `bg-primary` class (primary is already orange in both themes)
- `theme.senderText` -> `text-primary-foreground` class
- `theme.recipientBubble` -> `bg-muted` class
- `theme.homeIndicator` -> `bg-muted-foreground/20` class

For each element currently using `style={{ backgroundColor: theme.xxx, color: theme.yyy }}`, convert to className-based Tailwind:
- Replace `style={{ backgroundColor: theme.background }}` with `className="bg-background"`
- Replace `style={{ color: theme.textPrimary }}` with `className="text-foreground"`
- etc.

**5. Update SwipeableMessage component**:
- Remove `theme` prop entirely from SwipeableMessage
- Add `isUser` prop (already exists)
- Replace `style={{ backgroundColor: isUser ? theme.senderBubble : theme.recipientBubble }}` with `className={isUser ? 'bg-primary' : 'bg-muted'}`
- Replace `style={{ color: ... }}` with Tailwind classes
- For timestamp color: use `text-muted-foreground` for recipient, `text-primary-foreground/70` for user
- Update MessageContent usage: change `textColor={...}` prop to `isUser={isUser}` prop (matching the new MessageContent interface from Plan 02)

**6. Update theme toggle button** in the header:
- Replace `onClick={() => setIsDark(!isDark)}` with `onClick={() => setTheme(resolvedTheme === 'dark' ? 'light' : 'dark')}`
- Use mounted guard: only render the icon after mounted (render a placeholder div with same dimensions before mount)
- Show Sun icon when dark, Moon when light (current behavior, keep it)

**7. Loading indicator (typing dots)**:
- Replace `style={{ backgroundColor: theme.textSecondary }}` with `className="bg-muted-foreground"`
- Replace `style={{ backgroundColor: theme.recipientBubble }}` with `className="bg-muted"`
- Deep search indicator: keep `#EA580C` as it's brand orange (or use `text-primary`)

**8. Input area**:
- Replace `style={{ backgroundColor: theme.navBg }}` with `className="bg-card"`
- Replace `style={{ border: ... }}` with `className="border border-border"` (and `border-primary` when deepSearchEnabled)
- Replace `style={{ color: theme.textPrimary }}` with `className="text-foreground"`
- The deepSearchEnabled highlight can use `border-primary` and `ring-primary/30`

**9. Other hardcoded colors to address**:
- `#EA580C` in various places -> use `text-primary` or `bg-primary` (the CSS variable --primary is already set to SoulPrint orange in both themes)
- `rgba(234, 88, 12, 0.15)` -> `bg-primary/15`
- `rgba(234, 88, 12, 0.3)` -> `ring-primary/30`
- `#8E8E93` (placeholder color) -> keep as-is or use `placeholder:text-muted-foreground`
- `#EF4444` (recording red) -> keep as-is (semantic color, not theme-dependent)

**10. Remove `transition-colors duration-300`** from elements that no longer need it (theme switch is now handled by class change on html, not individual element transitions). The `disableTransitionOnChange` prop on ThemeProvider already prevents FOUC.

IMPORTANT: Keep all existing functionality (swipe gestures, voice recording, deep search toggle, message queue). Only change the theming approach.
  </action>
  <verify>
Run `npm run build` -- should complete without errors.
Grep for hardcoded hex colors -- should find minimal instances (only brand colors like recording red #EF4444, gradient on avatar):
```bash
grep -n '#[0-9a-fA-F]\{6\}' components/chat/telegram-chat-v2.tsx
```
Verify `useTheme` is imported and used. Verify the `themes` object constant is removed. Verify `textColor` is no longer passed to MessageContent.
  </verify>
  <done>
telegram-chat-v2.tsx uses Tailwind CSS variable classes for all theme-dependent colors. Local theme state removed, useTheme from next-themes controls the toggle. No hardcoded light/dark hex colors remain (only brand accent and semantic colors). MessageContent receives isUser prop instead of textColor.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix hardcoded colors in chat page and settings modals</name>
  <files>app/chat/page.tsx</files>
  <action>
Update `app/chat/page.tsx` to replace all hardcoded dark-mode-only colors with Tailwind theme classes:

**1. Remove `defaultDarkMode={true}` prop** from `<TelegramChatV2>` (prop no longer exists after Task 1).

**2. Loading screen** (loadingHistory state, ~line 542-551):
- Replace `bg-[#0a0a0a]` with `bg-background`
- Replace `border-[#EA580C]` with `border-primary`
- Replace `text-[#a3a3a3]` with `text-muted-foreground`

**3. Memory Building indicator** (~line 584-593):
- Replace `bg-[#1a1a1a]/90` with `bg-card/90`
- Replace `border-[#262626]` with `border-border`
- Replace `border-[#EA580C]` with `border-primary`
- Replace `text-[#a3a3a3]` with `text-muted-foreground`

**4. Import Failed indicator** (~line 596-610):
- Replace `text-[#EA580C]` with `text-primary`
- Replace `hover:text-[#C2410C]` with `hover:text-primary/80`

**5. Settings Modal** (~line 616-657):
- Replace `bg-[#111]` with `bg-card`
- Replace `text-white` with `text-foreground`
- Replace `text-[#EA580C]` with `text-primary`
- Replace `bg-[#1a1a1a]` with `bg-muted`
- Replace `border-[#262626]` with `border-border`
- Replace `text-[#a3a3a3]` with `text-muted-foreground`
- Replace `hover:bg-[#262626]` with `hover:bg-accent`

**6. Rename Modal** (~line 660-690):
- Same pattern: replace all hardcoded hex colors with Tailwind theme classes
- `bg-[#111]` -> `bg-card`
- `text-white` -> `text-foreground`
- `bg-[#1a1a1a]` -> `bg-muted`
- `border-[#262626]` -> `border-border`
- `text-[#737373]` -> `text-muted-foreground`
- `focus:ring-[#EA580C]` -> `focus:ring-primary`
- `bg-[#EA580C]` -> `bg-primary`
- `hover:bg-[#C2410C]` -> `hover:bg-primary/85`

**7. Save Error banner** (~line 569-581):
- Keep red semantic colors (bg-red-500/10, text-red-400, border-red-500/30) -- these are intentionally red regardless of theme

After changes, grep the file for remaining hardcoded hex colors. Only `#EA580C`-family colors used as semantic brand accents in places where `text-primary/bg-primary` doesn't apply should remain (and there should be very few -- most should be converted to primary).
  </action>
  <verify>
Run `npm run build` -- should complete without errors.
Grep for hardcoded hex colors:
```bash
grep -n '#[0-9a-fA-F]\{6\}' app/chat/page.tsx
```
Should return 0 or very few results (only semantic colors like red for errors). All dark-mode-assuming colors (bg-[#0a0a0a], text-[#a3a3a3], etc.) should be gone.
  </verify>
  <done>
Chat page loading screen, memory indicators, settings modal, and rename modal all use Tailwind theme classes. Components render correctly in both light and dark modes without invisible text or broken contrast.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete rich rendering and dark mode implementation:
1. ThemeProvider wired into root layout with system preference detection
2. AI responses render with full markdown (headers, lists, bold, italic, links, tables)
3. Code blocks have syntax highlighting with language label and copy button
4. Theme toggle in chat header switches between light/dark modes
5. All chat UI elements (loading, settings, modals) respect theme
6. XSS sanitization blocks javascript: links and unsafe HTML
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to `/chat`
3. **Dark mode toggle**: Click the sun/moon icon in the header -- entire UI should switch themes. Refresh page -- theme should persist.
4. **System preference**: In browser DevTools, toggle `prefers-color-scheme` -- on first visit (clear localStorage), app should match OS preference.
5. **Markdown rendering**: Send a message asking the AI to "show me examples of markdown: headers, bold, italic, code blocks, a table, and a list". Verify all render correctly.
6. **Code blocks**: Ask "write me a hello world in Python". Verify syntax highlighting appears, language label shows "python", copy button works (click it, paste elsewhere).
7. **Light mode check**: Switch to light mode. Verify:
   - All text is readable (dark on light background)
   - Settings modal is not invisible
   - Loading indicators are visible
   - Chat bubbles have appropriate contrast
8. **XSS test**: If possible, ask AI to include `[click](javascript:alert('xss'))` in response -- should render as plain text, not a clickable link.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with rendering, theme switching, or contrast</resume-signal>
</task>

</tasks>

<verification>
1. Theme toggles globally via next-themes (not local component state)
2. telegram-chat-v2.tsx has no hardcoded theme color objects
3. chat/page.tsx has no dark-mode-only hardcoded colors
4. All UI elements readable in both light and dark modes
5. Settings and rename modals work in both themes
6. Build passes with no errors
</verification>

<success_criteria>
- User can toggle dark/light via header button, theme persists across refreshes
- System preference respected on first visit
- No invisible text, broken contrast, or unreadable content in either theme
- Settings modal, loading screens, and status indicators all theme-aware
- Markdown rendering and code blocks work correctly in both themes
</success_criteria>

<output>
After completion, create `.planning/phases/11-rich-rendering-dark-mode/11-03-SUMMARY.md`
</output>
