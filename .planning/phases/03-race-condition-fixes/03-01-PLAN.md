---
phase: 03-race-condition-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/import/queue-processing/route.ts
  - app/import/page.tsx
autonomous: true

must_haves:
  truths:
    - "Starting a new import while one is processing returns HTTP 409 Conflict"
    - "Stuck imports (>15 min) are automatically superseded by new import attempts"
    - "Import page shows user-friendly message when duplicate is rejected"
    - "processing_started_at is recorded atomically when import begins"
  artifacts:
    - path: "app/api/import/queue-processing/route.ts"
      provides: "Duplicate import detection with 409 response"
      contains: "409"
    - path: "app/import/page.tsx"
      provides: "Client-side handling of 409 duplicate rejection"
      contains: "409"
  key_links:
    - from: "app/import/page.tsx"
      to: "app/api/import/queue-processing/route.ts"
      via: "fetch POST with 409 handling"
      pattern: "409|already.+in.+progress|conflict"
    - from: "app/api/import/queue-processing/route.ts"
      to: "user_profiles table"
      via: "import_status + processing_started_at check"
      pattern: "import_status.*processing"
---

<objective>
Add duplicate import detection and cancellation logic to prevent concurrent imports for the same user.

Purpose: BUG-02 fix -- when a user starts a new import while one is already processing, the system must either reject the duplicate (if the existing job is fresh) or allow retry (if the existing job is stuck >15 min). Without this, duplicate imports cause database conflicts and wasted resources.

Output: Queue-processing route rejects duplicate imports with 409, import page handles the rejection gracefully.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-race-condition-fixes/03-RESEARCH.md

@app/api/import/queue-processing/route.ts
@app/import/page.tsx
@lib/api/error-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add duplicate import guard to queue-processing route</name>
  <files>app/api/import/queue-processing/route.ts</files>
  <action>
Add duplicate import detection BEFORE the existing `adminSupabase.from('user_profiles').upsert(...)` call that sets status to 'processing'. The guard logic:

1. After authenticating the user and before starting processing, query `user_profiles` for the current user:
   ```
   SELECT import_status, processing_started_at FROM user_profiles WHERE user_id = $userId
   ```

2. If `import_status === 'processing'`:
   a. Calculate elapsed time from `processing_started_at`
   b. If elapsed < 15 minutes: return 409 Conflict with JSON body:
      ```json
      { "error": "Import already in progress. Please wait for it to complete.", "status": "processing", "elapsedMinutes": N }
      ```
   c. If elapsed >= 15 minutes: log warning about stuck import and CONTINUE (allow the new import to supersede). Log: `[QueueProcessing] Stuck import detected (${elapsed}min), allowing retry for user ${user.id}`

3. Also add `processing_started_at: new Date().toISOString()` to the existing upsert that sets `import_status: 'processing'` (this field may already be set in some code paths but ensure it's consistently set in the upsert right after the guard).

Keep existing error handling via handleAPIError pattern. Do NOT change the Motia path or the legacy process-server path logic -- only add the guard at the top of the POST handler after auth.

Research reference: See Pattern 2 in 03-RESEARCH.md for the exact approach. Use passive rejection (return 409) rather than active cancellation per research recommendation.
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Grep the route file for "409" and "already in progress" to confirm guard is present. Verify the existing test suite still passes with `npx vitest run`.
  </verify>
  <done>
Queue-processing route checks import_status before starting new import. Fresh imports (<15 min) are rejected with 409. Stuck imports (>=15 min) are allowed to retry. processing_started_at is set atomically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Handle 409 duplicate rejection on import page</name>
  <files>app/import/page.tsx</files>
  <action>
In the `handleFile` function, where `queueRes` is checked for `!queueRes.ok`, add specific handling for HTTP 409:

1. After the fetch to `/api/import/queue-processing`, check `queueRes.status === 409` specifically:
   - Parse the JSON response to get `elapsedMinutes`
   - Set a user-friendly error message: "An import is already processing (started ${elapsedMinutes} minutes ago). Please wait for it to complete, or try again in a few minutes."
   - Set `status` to `'error'` and clear the progress interval
   - Return early (do not fall through to the generic error handler)

2. The existing generic `!queueRes.ok` handler stays as fallback for other errors.

3. Also handle the case where the user's initial status check (the `checkExisting` useEffect) finds `import_status === 'processing'` with a NON-stuck duration (<15 min) -- this already redirects to `/chat` which is correct. No change needed there.

Do NOT change any other part of the import flow (upload logic, ZIP extraction, etc.).
  </action>
  <verify>
Run `npm run build` to verify no TypeScript errors. Read the file and confirm the 409 handling branch exists before the generic error handler.
  </verify>
  <done>
Import page shows "An import is already processing" message when server returns 409. User sees elapsed time and clear guidance. Generic error fallback still handles other HTTP errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. `npx vitest run` -- all existing tests pass
3. Manual code review: queue-processing route has duplicate guard before upsert
4. Manual code review: import page handles 409 response distinctly from other errors
</verification>

<success_criteria>
- Queue-processing route returns 409 when import_status is 'processing' and elapsed < 15 min
- Queue-processing route allows retry when import has been stuck > 15 min
- Import page displays user-friendly duplicate rejection message
- processing_started_at is consistently set when import begins
- No regressions in build or existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-race-condition-fixes/03-01-SUMMARY.md`
</output>
