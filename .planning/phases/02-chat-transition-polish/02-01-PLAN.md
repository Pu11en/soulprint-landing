---
phase: 02-chat-transition-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/template.tsx
  - app/import/page.tsx
  - app/chat/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees smooth fade transition (300ms) from import page to chat page instead of jarring redirect"
    - "User never sees blank screen or white flash during import-to-chat navigation"
    - "User's chat interface is ready and welcoming when they arrive (no loading spinner visible)"
    - "User's browser prefetches chat route during import processing to mask latency"
  artifacts:
    - path: "app/template.tsx"
      provides: "Framer Motion fade transition wrapper for all page navigations"
      min_lines: 15
      contains: "motion"
    - path: "app/import/page.tsx"
      provides: "Coordinated completion animation with prefetch before navigation"
      contains: "router.prefetch"
    - path: "app/chat/page.tsx"
      provides: "Fade-in entry animation on chat page load"
      contains: "motion"
  key_links:
    - from: "app/template.tsx"
      to: "framer-motion"
      via: "motion.div wrapping children with key-based fade"
      pattern: "motion\\.div"
    - from: "app/import/page.tsx"
      to: "/chat"
      via: "router.prefetch then router.push after completion animation"
      pattern: "router\\.prefetch.*chat"
    - from: "app/chat/page.tsx"
      to: "framer-motion"
      via: "motion.div fade-in wrapper on mount"
      pattern: "motion\\.div.*initial.*opacity.*0"
---

<objective>
Create a smooth fade transition from the import page to chat page, replacing the jarring `router.push('/chat')` redirect with a choreographed completion animation + prefetch + fade.

Purpose: Users completing their import should feel a seamless, polished handoff into their personalized chat — not a jarring page hop with a flash of loading spinner.

Output:
- `app/template.tsx` — Framer Motion fade wrapper for page transitions
- Updated `app/import/page.tsx` — Prefetch + choreographed exit
- Updated `app/chat/page.tsx` — Fade-in entry + suppressed loading flash
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/template.tsx (DOES NOT EXIST YET — create it)
@app/layout.tsx
@app/import/page.tsx
@app/chat/page.tsx
@components/import/animated-progress-stages.tsx
@lib/import/progress-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template.tsx fade wrapper + orchestrate import-to-chat transition</name>
  <files>
    app/template.tsx
    app/import/page.tsx
  </files>
  <action>
**1. Create `app/template.tsx`** — App Router page transition wrapper.

This file re-renders on every route change (unlike layout.tsx which persists). Use it to wrap page content in a Framer Motion fade:

```tsx
'use client';

import { motion } from 'framer-motion';

export default function Template({ children }: { children: React.ReactNode }) {
  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.3, ease: 'easeInOut' }}
      style={{ height: '100%' }}
    >
      {children}
    </motion.div>
  );
}
```

IMPORTANT design notes:
- Do NOT use AnimatePresence here (per user decision — breaks with App Router because layout.tsx doesn't unmount/remount children in a way AnimatePresence can track).
- The fade-IN is what template.tsx provides. The outgoing page simply disappears when Next.js navigates. The incoming page fades in smoothly via the template wrapper.
- Set `style={{ height: '100%' }}` to avoid breaking the `h-[100dvh]` layouts on both import and chat pages.
- Do NOT add `exit` animation — App Router does not support exit animations via template.tsx (the old page is immediately unmounted). The smoothness comes from: (a) both pages share `bg-black` so there's no white flash, and (b) the new page fades in from opacity 0.

**2. Modify `app/import/page.tsx`** — Orchestrate completion transition.

Changes needed:

a) **Add early prefetch**: In the `startPolling` callback setup (or in a useEffect that runs when phase becomes 'processing'), call `router.prefetch('/chat')`. This tells Next.js to prefetch the chat page's JS bundle and RSC payload in the background, so when we navigate, the transition is near-instant.

Add this as a standalone useEffect:
```tsx
// Prefetch chat route as soon as processing starts
useEffect(() => {
  if (phase === 'processing') {
    router.prefetch('/chat');
  }
}, [phase, router]);
```

b) **Replace completion navigation**: In the `startPolling` callback, the current code (around line 58-62) does:
```tsx
if (data.import_status === 'quick_ready' || data.import_status === 'complete') {
  if (pollRef.current) clearInterval(pollRef.current);
  setProgress(100);
  setStage('Done! Opening chat...');
  setTimeout(() => router.push('/chat'), 800);
}
```

Replace the `setTimeout(() => router.push('/chat'), 800)` with a longer, more intentional completion ceremony:
```tsx
if (data.import_status === 'quick_ready' || data.import_status === 'complete') {
  if (pollRef.current) clearInterval(pollRef.current);
  setProgress(100);
  setStage('Your SoulPrint is ready!');
  // Let the user see the completed state for 1.2s, then navigate.
  // template.tsx handles the fade-in on the chat page.
  setTimeout(() => router.push('/chat'), 1200);
}
```

The stage message change from "Done! Opening chat..." to "Your SoulPrint is ready!" gives a more satisfying completion moment. The 1200ms delay lets the progress bar reach 100% and the completion state register visually before the page changes. Combined with template.tsx's 300ms fade-in on the chat side, the user experience becomes: see 100% + "ready" message -> page changes -> chat fades in smoothly.

c) **Also update the early redirect** (around line 90-91): When the user visits /import and they already have data (`data.status === 'ready'`), the current code does `router.push('/chat')`. This is fine to keep as-is — template.tsx will handle the fade-in automatically.

d) **No other changes to import/page.tsx** — the AnimatePresence usage within the import page (for phase transitions between instructions/upload/processing/error) stays exactly as is.
  </action>
  <verify>
1. `cat app/template.tsx` confirms file exists with motion.div fade wrapper
2. `grep -n 'router.prefetch' app/import/page.tsx` shows prefetch call
3. `grep -n 'Your SoulPrint is ready' app/import/page.tsx` shows updated completion message
4. `grep -n 'setTimeout.*1200' app/import/page.tsx` shows extended delay
5. `npm run build` passes (confirms template.tsx is valid App Router template)
  </verify>
  <done>
- app/template.tsx exists with Framer Motion fade-in wrapper (opacity 0 -> 1, 300ms)
- Import page prefetches /chat route when processing starts
- Import completion shows "Your SoulPrint is ready!" for 1.2s before navigating
- Build succeeds with no errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add chat page fade-in entry and suppress loading flash</name>
  <files>
    app/chat/page.tsx
  </files>
  <action>
Modify the chat page so users arriving from import see a smooth, ready-to-use interface — not a loading spinner.

**1. Add Framer Motion import** at the top of the file:
```tsx
import { motion } from 'framer-motion';
```

**2. Wrap the loading state in a fade-in** (around line 846-855). The current loading screen shows a raw spinner on a white-ish background. This flashes briefly during page load before data arrives. Modify it to:

a) Use `bg-black` instead of `bg-background` so it matches the import page's black background during transition. This prevents the white flash.

b) Add a Framer Motion fade-in so even the loading state appears smoothly:

```tsx
if (loadingHistory) {
  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.3 }}
      className="fixed inset-0 h-screen w-screen bg-black flex items-center justify-center"
    >
      <div className="flex flex-col items-center gap-4">
        <div className="w-8 h-8 border-2 border-orange-500 border-t-transparent rounded-full animate-spin" />
        <span className="text-white/60 text-sm">Loading your memories...</span>
      </div>
    </motion.div>
  );
}
```

Key changes from current code:
- `bg-background` -> `bg-black` (matches import page during transition, prevents white flash)
- `text-muted-foreground` -> `text-white/60` (matches dark theme during transition)
- `border-primary` -> `border-orange-500` (matches SoulPrint orange brand)
- `border-t-transparent` stays as-is (spinner effect)
- Wrapped in `motion.div` with fade-in

**3. Wrap the main chat content** (the return statement at line 857) in a motion.div fade-in. This ensures that when `loadingHistory` becomes false and the real chat UI renders, it also fades in smoothly:

Wrap the existing `<>...</>` fragment content. Since fragments can't have motion, add a motion.div wrapper INSIDE the fragment, around all the visible content:

```tsx
return (
  <>
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      transition={{ duration: 0.3, delay: 0.05 }}
      style={{ position: 'fixed', inset: 0, height: '100vh', width: '100vw' }}
    >
      {/* Conversation Sidebar */}
      <ConversationSidebar ... />

      {/* Main Chat Area */}
      <div className="fixed inset-0 h-screen w-screen">
        <TelegramChatV2 ... />
      </div>
    </motion.div>

    {/* Keep modals/overlays OUTSIDE the motion wrapper so they aren't affected */}
    {saveError && (...)}
    {memoryStatus === 'building' && (...)}
    {memoryStatus === 'failed' && (...)}
    <AddToHomeScreen ... />
    {showSettings && (...)}
    {showRename && (...)}
  </>
);
```

The 0.05s delay ensures the fade-in starts just after the template.tsx fade, creating a layered appearance effect. The modals/overlays stay outside so they aren't affected by the entry animation.

**IMPORTANT: Do NOT change any logic, state management, data fetching, or other functionality in chat/page.tsx.** Only add motion wrappers and change the loading state's background color from `bg-background` to `bg-black` and its text/border colors to match.
  </action>
  <verify>
1. `grep -n 'motion' app/chat/page.tsx` shows motion import and usage
2. `grep -n 'bg-black' app/chat/page.tsx` shows black background on loading state
3. `grep -n 'border-orange-500' app/chat/page.tsx` shows branded spinner
4. `npm run build` passes
5. No functional changes: `grep -c 'router.push' app/chat/page.tsx` still shows same number of router.push calls as before
  </verify>
  <done>
- Chat page loading state uses bg-black (no white flash during transition)
- Chat page loading state has motion.div fade-in wrapper
- Chat page main content wrapped in motion.div fade-in
- Modals/overlays not affected by transition animation
- Build succeeds, no functional changes to chat logic
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Smooth fade transition from import completion to chat page. The flow should now be:
1. Import completes -> progress hits 100% -> "Your SoulPrint is ready!" message appears
2. After 1.2 seconds, page navigates to /chat
3. Chat page fades in smoothly (300ms) over a black background (no white flash)
4. Chat interface is ready with welcome message (loading spinner is brief and also fades in on black)
  </what-built>
  <how-to-verify>
**Best test: Full import flow**
1. Go to `/import?reimport=true` (or reset data first)
2. Upload a ChatGPT export ZIP
3. Watch the import process through all stages
4. When it hits 100%, observe:
   - "Your SoulPrint is ready!" message appears
   - After ~1.2s, the page transitions to chat
   - The transition is a smooth fade (no jarring jump, no white flash)
   - Chat loads with the welcome message visible

**Quick test: Direct navigation**
1. Go to `/chat` directly (if you have imported data)
2. The page should fade in smoothly (300ms)
3. No white flash between pages
4. Loading spinner (if briefly visible) shows on black background with orange spinner

**Mobile test:**
5. Open on phone (or mobile emulator)
6. Navigate from import to chat
7. No layout shift, no jank, no white flash

**What to look for:**
- PASS: Smooth, professional fade between pages. No jarring jumps.
- FAIL: White flash, visible layout shift, spinner on white background, instant jump without fade
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the transition</resume-signal>
</task>

</tasks>

<verification>
1. `app/template.tsx` exists and contains Framer Motion fade wrapper
2. `app/import/page.tsx` calls `router.prefetch('/chat')` during processing phase
3. `app/import/page.tsx` shows completion message then navigates after 1200ms
4. `app/chat/page.tsx` loading state uses `bg-black` (no white flash)
5. `app/chat/page.tsx` main content wrapped in motion.div fade-in
6. `npm run build` passes with no errors
7. No new dependencies added (Framer Motion 12.29.2 already installed)
</verification>

<success_criteria>
- Smooth fade transition (300ms) between import and chat pages
- No blank screen, white flash, or jarring redirect at any point in the import-to-chat flow
- Chat page loading state and main content both fade in on black background
- Import page prefetches /chat route during processing
- Build passes, no regressions to existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-chat-transition-polish/02-01-SUMMARY.md`
</output>
