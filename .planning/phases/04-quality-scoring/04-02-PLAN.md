---
phase: 04-quality-scoring
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/soulprint/prompt-builder.ts
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "Quality scores are surfaced in system prompts so AI adapts confidence level in responses"
    - "AI acknowledges uncertainty for low-confidence soulprint sections instead of hallucinating"
    - "Chat route loads quality_breakdown alongside existing profile fields"
  artifacts:
    - path: "lib/soulprint/prompt-builder.ts"
      provides: "DATA CONFIDENCE section builder + updated PromptBuilderProfile type"
      exports: ["PromptBuilder", "PromptBuilderProfile"]
    - path: "app/api/chat/route.ts"
      provides: "Chat route loading quality_breakdown from user_profiles"
  key_links:
    - from: "lib/soulprint/prompt-builder.ts"
      to: "lib/evaluation/quality-scoring.ts"
      via: "QualityBreakdown type import for DATA CONFIDENCE section"
      pattern: "import.*QualityBreakdown.*from.*quality-scoring"
    - from: "app/api/chat/route.ts"
      to: "lib/soulprint/prompt-builder.ts"
      via: "Passes quality_breakdown to PromptParams"
      pattern: "quality_breakdown|qualityBreakdown"
---

<objective>
Surface quality scores in system prompts via a DATA CONFIDENCE section, so the AI knows its own data quality and acknowledges uncertainty for low-confidence areas.

Purpose: QUAL-02 requires quality scores in the system prompt. This directly improves response quality -- when the AI knows its TOOLS section scored 35/100 on completeness, it says "I don't have detailed tool preference info" instead of guessing. This extends the EMOT-02 uncertainty acknowledgment pattern from Phase 3.

Output: Updated PromptBuilder with DATA CONFIDENCE section, updated chat route loading quality_breakdown.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-quality-scoring/04-RESEARCH.md
@.planning/phases/04-quality-scoring/04-01-SUMMARY.md
@lib/soulprint/prompt-builder.ts
@lib/evaluation/quality-scoring.ts
@app/api/chat/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: PromptBuilder DATA CONFIDENCE Section</name>
  <files>lib/soulprint/prompt-builder.ts</files>
  <action>
Modify `lib/soulprint/prompt-builder.ts` to add quality-aware prompt construction.

**Step 1: Import QualityBreakdown type**
Add import at top of file:
```typescript
import type { QualityBreakdown } from '@/lib/evaluation/quality-scoring';
```

**Step 2: Update PromptBuilderProfile**
Add optional `quality_breakdown` field:
```typescript
export interface PromptBuilderProfile {
  // ... existing fields unchanged ...
  quality_breakdown?: QualityBreakdown | null;
}
```

**Step 3: Create buildDataConfidenceSection function**
Add as a private method on PromptBuilder class:

```typescript
private buildDataConfidenceSection(qualityBreakdown: QualityBreakdown | null | undefined): string {
  if (!qualityBreakdown) return '';

  // Calculate overall confidence
  const allScores: number[] = [];
  for (const sectionMetrics of Object.values(qualityBreakdown)) {
    for (const score of Object.values(sectionMetrics as Record<string, number>)) {
      allScores.push(score);
    }
  }

  if (allScores.length === 0) return '';

  const avgScore = allScores.reduce((sum, s) => sum + s, 0) / allScores.length;
  const confidenceLevel = avgScore >= 80 ? 'HIGH' : avgScore >= 60 ? 'MODERATE' : 'LOW';

  // Identify weak areas (any metric < 60)
  const weakAreas: string[] = [];
  for (const [section, metrics] of Object.entries(qualityBreakdown)) {
    for (const [metric, score] of Object.entries(metrics as Record<string, number>)) {
      if (score < 60) {
        weakAreas.push(`${section}.${metric}: ${score}/100`);
      }
    }
  }

  let text = `## DATA CONFIDENCE\n\nOverall profile quality: ${confidenceLevel} (${Math.round(avgScore)}/100)`;

  if (weakAreas.length > 0) {
    text += `\n\nLow-confidence areas:`;
    for (const weak of weakAreas) {
      text += `\n- ${weak}`;
    }
    text += `\n\nWhen responding about low-confidence areas, acknowledge uncertainty explicitly. Say "I don't have enough information about X" rather than guessing or fabricating details.`;
  } else {
    text += `\n\nAll sections are well-populated. Respond with confidence based on the profile data.`;
  }

  return text;
}
```

**Step 4: Insert DATA CONFIDENCE into both v1 and v2 prompt builders**

In `buildTechnicalPrompt` (v1): Insert DATA CONFIDENCE section AFTER the soulprint sections (after TOOLS/MEMORY/DAILY MEMORY) but BEFORE the `## CONTEXT` (memoryContext) section. Place it right before the `if (memoryContext)` block.

In `buildNaturalVoicePrompt` (v2): Same position -- after the soulprint personality sections and DAILY MEMORY, but BEFORE `## CONTEXT` (memoryContext) block.

Both insertions follow this pattern:
```typescript
// DATA CONFIDENCE section (after soulprint, before CONTEXT)
const dataConfidence = this.buildDataConfidenceSection(profile.quality_breakdown);
if (dataConfidence) {
  prompt += `\n\n${dataConfidence}`;
}
```

IMPORTANT: Do NOT modify the `buildEmotionallyIntelligentPrompt` method. DATA CONFIDENCE is part of the base prompt, not the EI layer. The EI method calls `buildSystemPrompt` which already includes DATA CONFIDENCE.

IMPORTANT: Do NOT change any existing prompt output for profiles without quality_breakdown. When quality_breakdown is null/undefined, the function returns empty string and nothing changes.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors. Verify that PromptBuilderProfile now includes `quality_breakdown`. Verify that buildDataConfidenceSection is called in both v1 and v2 builders. Verify that existing tests still pass: `npx vitest run --grep "PromptBuilder"`.
  </verify>
  <done>
- PromptBuilder has `buildDataConfidenceSection` private method
- Both v1 and v2 prompt builders include DATA CONFIDENCE section after soulprint sections, before CONTEXT
- Profiles without quality_breakdown produce identical prompts (backward compatible)
- Low-confidence areas (<60) generate explicit uncertainty instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Chat Route Quality Loading</name>
  <files>app/api/chat/route.ts</files>
  <action>
Modify `app/api/chat/route.ts` to load `quality_breakdown` from user_profiles and pass it to the PromptBuilder.

**Step 1: Update the profile SELECT query (around line 234)**
Add `quality_breakdown` to the select fields:

Current:
```typescript
.select('soulprint_text, import_status, ai_name, soul_md, identity_md, user_md, agents_md, tools_md, memory_md')
```

Updated:
```typescript
.select('soulprint_text, import_status, ai_name, soul_md, identity_md, user_md, agents_md, tools_md, memory_md, quality_breakdown')
```

**Step 2: Ensure quality_breakdown flows through to PromptBuilder**
The profile object from Supabase will now include `quality_breakdown`. Since PromptBuilder receives the profile object, and PromptBuilderProfile now has `quality_breakdown` as an optional field, it will automatically flow through.

Look for where `userProfile` is constructed or passed to `buildEmotionallyIntelligentPrompt` (around line 456). The profile object passed there should already include the quality_breakdown since it comes from the Supabase query result. Verify the profile object passed as `profile:` in the params includes `quality_breakdown`.

If the profile is spread or reconstructed (e.g., `profile: { soulprint_text: ..., ... }`), add `quality_breakdown: profile?.quality_breakdown ?? null` to that object.

**Step 3: Type the quality_breakdown field**
The Supabase query returns `quality_breakdown` as `unknown`. When constructing the profile object for PromptBuilder, cast it:
```typescript
quality_breakdown: (profile?.quality_breakdown as QualityBreakdown | null) ?? null
```

Add the type import at the top of the file:
```typescript
import type { QualityBreakdown } from '@/lib/evaluation/quality-scoring';
```

IMPORTANT: Do NOT change any other behavior of the chat route. This is a read-only addition -- loading one more column and passing it through.

IMPORTANT: The RLM path does NOT use the PromptBuilder (per 03-02 decision). Only the Bedrock fallback path uses PromptBuilder, so DATA CONFIDENCE only applies there. This is correct behavior -- RLM builds its own prompts server-side.
  </action>
  <verify>
Run `npx tsc --noEmit app/api/chat/route.ts` -- no type errors. Verify the select query includes `quality_breakdown`. Verify the profile object passed to `buildEmotionallyIntelligentPrompt` includes `quality_breakdown`. Run `npx vitest run` to confirm no test regressions.
  </verify>
  <done>
- Chat route loads `quality_breakdown` from user_profiles in a single query (no extra DB call)
- quality_breakdown flows to PromptBuilder for DATA CONFIDENCE section injection
- Backward compatible: null quality_breakdown produces no DATA CONFIDENCE section
- No changes to RLM path, only Bedrock fallback path gains quality awareness
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npx vitest run` -- all existing tests pass (no regressions)
3. PromptBuilder with quality_breakdown produces prompt containing `## DATA CONFIDENCE`
4. PromptBuilder without quality_breakdown produces identical output to before (backward compatible)
5. Chat route query includes `quality_breakdown` column
</verification>

<success_criteria>
- System prompt includes DATA CONFIDENCE section when quality_breakdown is available
- Low-confidence areas (<60) generate explicit uncertainty instructions for the AI
- Chat route loads quality_breakdown from DB without adding extra queries
- Backward compatible: no quality_breakdown = no change to prompt output
</success_criteria>

<output>
After completion, create `.planning/phases/04-quality-scoring/04-02-SUMMARY.md`
</output>
