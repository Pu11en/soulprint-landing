---
phase: 03-emotional-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/soulprint/emotional-intelligence.ts
  - lib/soulprint/prompt-builder.ts
autonomous: true

must_haves:
  truths:
    - "EmotionalState type defines frustrated/satisfied/confused/neutral with confidence and cues"
    - "detectEmotion returns emotional state from user message and recent history using Haiku 4.5"
    - "getRelationshipArc returns early/developing/established stage from message count"
    - "determineTemperature returns dynamic temperature based on emotion, query type, and memory context"
    - "PromptBuilder produces uncertainty acknowledgment, relationship arc, and adaptive tone sections"
  artifacts:
    - path: "lib/soulprint/emotional-intelligence.ts"
      provides: "EmotionalState type, detectEmotion, getRelationshipArc, determineTemperature, prompt section builders"
      exports: ["EmotionalState", "detectEmotion", "getRelationshipArc", "determineTemperature", "buildUncertaintyInstructions", "buildRelationshipArcInstructions", "buildAdaptiveToneInstructions"]
    - path: "lib/soulprint/prompt-builder.ts"
      provides: "Extended PromptBuilder with buildEmotionallyIntelligentPrompt method"
      contains: "buildEmotionallyIntelligentPrompt"
  key_links:
    - from: "lib/soulprint/prompt-builder.ts"
      to: "lib/soulprint/emotional-intelligence.ts"
      via: "import of EmotionalState, buildUncertaintyInstructions, buildRelationshipArcInstructions, buildAdaptiveToneInstructions"
      pattern: "from.*emotional-intelligence"
---

<objective>
Create the emotional intelligence module and extend PromptBuilder with emotionally adaptive prompt construction.

Purpose: Provides the core emotional intelligence capabilities (emotion detection, relationship arc, dynamic temperature, prompt section builders) that the chat route will wire into the response pipeline. This is the foundation that EMOT-01, EMOT-02, and EMOT-03 build upon.

Output: New `emotional-intelligence.ts` module with all EI functions, and extended PromptBuilder with `buildEmotionallyIntelligentPrompt` method.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-emotional-intelligence/03-RESEARCH.md
@lib/soulprint/prompt-builder.ts
@lib/soulprint/prompt-helpers.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create emotional intelligence module</name>
  <files>lib/soulprint/emotional-intelligence.ts</files>
  <action>
Create `lib/soulprint/emotional-intelligence.ts` with the following exports:

1. **EmotionalState interface:**
   ```typescript
   export interface EmotionalState {
     primary: 'frustrated' | 'satisfied' | 'confused' | 'neutral';
     confidence: number; // 0.0-1.0
     cues: string[];
   }
   ```

2. **detectEmotion(userMessage, recentHistory) -> Promise<EmotionalState>:**
   - Takes current user message and array of `{ role: string; content: string }` (last 3-5 messages)
   - Uses Bedrock Converse API (NOT ConverseStream) with Haiku 4.5 model (`us.anthropic.claude-3-5-haiku-20241022-v1:0`) for fast, cheap detection
   - Detection prompt defines frustration cues (repeated questions, short terse responses, complaints), satisfaction cues (positive words, enthusiasm), confusion cues (clarification requests, contradictory follow-ups), neutral (standard questions)
   - Returns JSON parsed from LLM response: `{ primary, confidence, cues }`
   - If confidence < 0.6, return `{ primary: 'neutral', confidence: 0.5, cues: [] }`
   - Wrap in try/catch: on ANY error, return neutral default (fail-safe, never crash chat)
   - Use existing BedrockRuntimeClient pattern from chat route (same credentials from env vars)
   - Set `inferenceConfig: { maxTokens: 150, temperature: 0.2 }` -- low temp for consistent detection
   - DO NOT set top_p (Pitfall 7 from research: Sonnet/Haiku on Bedrock require temperature XOR top_p)

3. **getRelationshipArc(messageCount) -> { stage, messageCount }:**
   - Pure function, no async needed
   - messageCount < 10 -> 'early'
   - messageCount >= 10 && < 50 -> 'developing'
   - messageCount >= 50 -> 'established'
   - Returns `{ stage: 'early' | 'developing' | 'established', messageCount }`

4. **determineTemperature(userMessage, emotionalState, hasMemoryContext) -> { temperature, reason }:**
   - Pure function, no async needed
   - Factual query pattern: `/^(what is|who is|when did|where is|how does)/i` AND no memory context -> temp 0.2
   - Confused emotional state -> temp 0.25
   - Creative task pattern: `/brainstorm|ideas|creative|suggest|imagine/i` -> temp 0.8
   - Default -> temp 0.7
   - Returns `{ temperature: number, reason: string }`

5. **buildUncertaintyInstructions() -> string:**
   - Returns the `## UNCERTAINTY ACKNOWLEDGMENT` section text (always included in prompts)
   - Content: instructions to say "I don't have enough info about X" instead of guessing, examples of good/bad responses, "Abstention is better than guessing"
   - Per research Pattern 3 and Pitfall 6: emphasize "When you lack SUFFICIENT information" (not overly cautious)

6. **buildRelationshipArcInstructions(arc) -> string:**
   - Takes `{ stage, messageCount }` from getRelationshipArc
   - Returns `## RELATIONSHIP TONE (Stage: N messages)` section with stage-specific instructions
   - early: cautious, clarifying questions, avoid overly familiar language
   - developing: balanced, reference past conversations, building rapport
   - established: confident, familiar, direct and opinionated
   - Returns empty string for invalid stage (defensive)

7. **buildAdaptiveToneInstructions(state) -> string:**
   - Takes EmotionalState
   - Returns `## ADAPTIVE TONE (User is X)` section with emotion-specific instructions
   - frustrated: supportive, concise, actionable, skip pleasantries, direct
   - satisfied: match energy, reinforce success, build momentum
   - confused: simplify, examples, break down, avoid jargon, be patient
   - neutral: return empty string (no adaptation needed)
   - Include detected cues in output: `Signs detected: ${state.cues.join(', ')}`

Important: The BedrockRuntimeClient should be created as a module-level singleton (same pattern as chat route) -- not created per-call.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Verify the file exports all 7 items: EmotionalState, detectEmotion, getRelationshipArc, determineTemperature, buildUncertaintyInstructions, buildRelationshipArcInstructions, buildAdaptiveToneInstructions.
  </verify>
  <done>
emotional-intelligence.ts exists with all 7 exports, compiles without type errors, and uses existing Bedrock patterns from the codebase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend PromptBuilder with emotional intelligence method</name>
  <files>lib/soulprint/prompt-builder.ts</files>
  <action>
Extend the existing PromptBuilder class in `lib/soulprint/prompt-builder.ts`:

1. **Import** from `./emotional-intelligence`:
   - `EmotionalState`, `buildUncertaintyInstructions`, `buildRelationshipArcInstructions`, `buildAdaptiveToneInstructions`

2. **Add EmotionallyIntelligentPromptParams interface:**
   ```typescript
   export interface EmotionallyIntelligentPromptParams extends PromptParams {
     emotionalState?: EmotionalState;
     relationshipArc?: { stage: 'early' | 'developing' | 'established'; messageCount: number };
   }
   ```

3. **Add buildEmotionallyIntelligentPrompt method to PromptBuilder class:**
   - Takes `EmotionallyIntelligentPromptParams`
   - Calls `this.buildSystemPrompt(params)` to get the base prompt (v1 or v2 depending on PROMPT_VERSION)
   - Appends `buildUncertaintyInstructions()` (ALWAYS included -- EMOT-02)
   - Appends `buildRelationshipArcInstructions(params.relationshipArc)` if relationshipArc provided (EMOT-03)
   - Appends `buildAdaptiveToneInstructions(params.emotionalState)` ONLY if emotionalState provided AND confidence >= 0.6 (EMOT-01, Pitfall 3)
   - The order matters: base prompt -> uncertainty -> relationship arc -> adaptive tone
   - Adaptive tone goes LAST so it's the freshest instruction to the LLM (closest to conversation)

4. **Do NOT modify existing methods** -- buildSystemPrompt, buildTechnicalPrompt, buildNaturalVoicePrompt remain untouched for backward compatibility.

5. **Export the new interface** from the module.
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Verify PromptBuilder has `buildEmotionallyIntelligentPrompt` method.
Verify existing PromptBuilder tests still pass: `npx vitest run lib/soulprint/`
  </verify>
  <done>
PromptBuilder class has buildEmotionallyIntelligentPrompt method that composes base prompt with uncertainty, relationship arc, and adaptive tone sections. Existing methods unchanged. All types compile.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `lib/soulprint/emotional-intelligence.ts` exists and exports all 7 items
- `lib/soulprint/prompt-builder.ts` has `buildEmotionallyIntelligentPrompt` method and `EmotionallyIntelligentPromptParams` type
- Existing tests pass: `npx vitest run lib/soulprint/`
</verification>

<success_criteria>
- EmotionalState type and all pure functions (getRelationshipArc, determineTemperature, 3 prompt section builders) are implemented
- detectEmotion uses Bedrock Haiku 4.5 with fail-safe neutral fallback
- PromptBuilder.buildEmotionallyIntelligentPrompt composes base + uncertainty + relationship + adaptive tone
- No existing functionality broken
</success_criteria>

<output>
After completion, create `.planning/phases/03-emotional-intelligence/03-01-SUMMARY.md`
</output>
