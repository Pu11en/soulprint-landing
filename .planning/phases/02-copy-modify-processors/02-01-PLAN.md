---
phase: 02-copy-modify-processors
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/drewpullen/clawd/soulprint-rlm/processors/__init__.py
  - /home/drewpullen/clawd/soulprint-rlm/processors/conversation_chunker.py
  - /home/drewpullen/clawd/soulprint-rlm/processors/fact_extractor.py
  - /home/drewpullen/clawd/soulprint-rlm/processors/memory_generator.py
  - /home/drewpullen/clawd/soulprint-rlm/processors/v2_regenerator.py
  - /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py
  - /home/drewpullen/clawd/soulprint-rlm/Dockerfile
autonomous: true

must_haves:
  truths:
    - "All 5 processor modules exist in production repo processors/ directory"
    - "full_pass.py imports download_conversations, update_user_profile, save_chunks_batch from adapters (not from main)"
    - "full_pass.py has no module-level SUPABASE_URL or SUPABASE_SERVICE_KEY variables"
    - "full_pass.py delete_user_chunks reads env vars inside function body (not module-level)"
    - "Dockerfile copies adapters/ and processors/ before main.py"
    - "Dockerfile build fails immediately if adapter or processor imports are broken (RUN python -c import check)"
    - "4 pure modules (conversation_chunker, fact_extractor, memory_generator, v2_regenerator) are byte-identical to v1.2 source"
  artifacts:
    - path: "processors/__init__.py"
      provides: "Package marker for processors directory"
    - path: "processors/conversation_chunker.py"
      provides: "Conversation chunking (estimate_tokens, chunk_conversations)"
    - path: "processors/fact_extractor.py"
      provides: "Parallel fact extraction (extract_facts_parallel, consolidate_facts, hierarchical_reduce)"
    - path: "processors/memory_generator.py"
      provides: "MEMORY section generation (generate_memory_section)"
    - path: "processors/v2_regenerator.py"
      provides: "V2 section regeneration (regenerate_sections_v2, sections_to_soulprint_text)"
    - path: "processors/full_pass.py"
      provides: "Pipeline orchestrator (run_full_pass_pipeline)"
    - path: "Dockerfile"
      provides: "Container build with import verification"
  key_links:
    - from: "Task 1 pre-flight"
      to: "adapters/__init__.py"
      via: "python -c 'from adapters import download_conversations, update_user_profile, save_chunks_batch'"
      pattern: "Adapter imports OK"
      note: "Verified BEFORE full_pass.py modifications begin -- ensures Phase 1 adapter layer is working"
    - from: "processors/full_pass.py"
      to: "adapters/__init__.py"
      via: "from adapters import download_conversations, update_user_profile, save_chunks_batch"
      pattern: "from adapters import"
    - from: "Dockerfile"
      to: "processors/"
      via: "COPY processors/ ./processors/"
      pattern: "COPY processors/"
    - from: "Dockerfile"
      to: "adapters/"
      via: "COPY adapters/ ./adapters/"
      pattern: "COPY adapters/"
---

<objective>
Copy 5 v1.2 processor modules to production soulprint-rlm repo, modify full_pass.py imports to use adapter layer, and update Dockerfile with import verification.

Purpose: Satisfies MERGE-01 (processor modules in production) and MERGE-04 (Dockerfile with import verification). After this plan, all processor code exists in production repo with correct imports.
Output: 6 files in processors/ directory + updated Dockerfile with build-time import checks.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-copy-modify-processors/02-RESEARCH.md
@.planning/phases/01-dependency-extraction/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy 4 pure processor modules and create __init__.py</name>
  <files>
    /home/drewpullen/clawd/soulprint-rlm/processors/__init__.py
    /home/drewpullen/clawd/soulprint-rlm/processors/conversation_chunker.py
    /home/drewpullen/clawd/soulprint-rlm/processors/fact_extractor.py
    /home/drewpullen/clawd/soulprint-rlm/processors/memory_generator.py
    /home/drewpullen/clawd/soulprint-rlm/processors/v2_regenerator.py
  </files>
  <action>
    **NOTE: This task works across TWO separate repos on disk:**
    - SOURCE repo: /home/drewpullen/clawd/soulprint-landing/rlm-service/ (v1.2 monolith with processors/)
    - TARGET repo: /home/drewpullen/clawd/soulprint-rlm/ (production repo, where Phase 1 already created adapters/)
    Both repos exist on disk and the executor has access to both.

    0. Pre-flight: Verify the adapter layer from Phase 1 is importable (required before full_pass.py modifications in Task 2):
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    python -c "from adapters import download_conversations, update_user_profile, save_chunks_batch; print('Adapter imports OK')"
    ```
    If this fails, STOP -- Phase 1 adapters must be working first.

    1. Create processors/ directory in /home/drewpullen/clawd/soulprint-rlm/

    2. Create processors/__init__.py with this content:
    ```python
    """
    SoulPrint RLM Service - Processors Package
    Background processing modules for full pass pipeline
    """
    ```

    3. Copy these 4 files EXACTLY as-is from /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/ to /home/drewpullen/clawd/soulprint-rlm/processors/:
       - conversation_chunker.py (248 lines, pure logic, no modifications)
       - fact_extractor.py (356 lines, pure logic, no modifications)
       - memory_generator.py (123 lines, pure logic, no modifications)
       - v2_regenerator.py (362 lines, pure logic, no modifications)

    These 4 modules have ZERO Supabase dependencies. Do NOT modify them. Copy verbatim.

    4. Verify byte-identical copy:
    ```bash
    diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/conversation_chunker.py /home/drewpullen/clawd/soulprint-rlm/processors/conversation_chunker.py
    diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/fact_extractor.py /home/drewpullen/clawd/soulprint-rlm/processors/fact_extractor.py
    diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/memory_generator.py /home/drewpullen/clawd/soulprint-rlm/processors/memory_generator.py
    diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/v2_regenerator.py /home/drewpullen/clawd/soulprint-rlm/processors/v2_regenerator.py
    ```
    All diffs must return empty (exit code 0).
  </action>
  <verify>
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    python -c "from processors.conversation_chunker import chunk_conversations, estimate_tokens; print('chunker OK')"
    python -c "from processors.fact_extractor import extract_facts_parallel, consolidate_facts; print('extractor OK')"
    python -c "from processors.memory_generator import generate_memory_section; print('memory OK')"
    python -c "from processors.v2_regenerator import regenerate_sections_v2, sections_to_soulprint_text; print('regenerator OK')"
    ```
    All 4 imports succeed with no errors.
  </verify>
  <done>4 pure processor modules and __init__.py exist in production processors/ directory, byte-identical to v1.2 source, all importable.</done>
</task>

<task type="auto">
  <name>Task 2: Modify full_pass.py imports and update Dockerfile</name>
  <files>
    /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py
    /home/drewpullen/clawd/soulprint-rlm/Dockerfile
  </files>
  <action>
    **NOTE: Cross-repo copy.** Source: /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/full_pass.py (v1.2 monolith). Target: /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py (production repo).

    **Pre-flight: Confirm adapter imports work** (Phase 1 must be complete):
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    python -c "from adapters import download_conversations, update_user_profile, save_chunks_batch; print('Adapter imports OK')"
    ```
    If this fails, STOP -- adapter layer from Phase 1 must be working first.

    **Part A: Copy and modify full_pass.py**

    1. Copy full_pass.py from v1.2 source:
       ```bash
       cp /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/full_pass.py /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py
       ```

    2. Apply these targeted modifications to /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py:

       a. REMOVE module-level env var lines (lines 13-15):
          ```python
          # DELETE these lines:
          # Supabase config from environment
          SUPABASE_URL = os.getenv("SUPABASE_URL")
          SUPABASE_SERVICE_KEY = os.getenv("SUPABASE_SERVICE_KEY")
          ```

       b. REMOVE local save_chunks_batch function (lines 47-104). The entire function including docstring.
          Reason: Adapter version from Phase 1 handles this with is_recent enrichment.

       c. KEEP the delete_user_chunks function (lines 18-44). This is processor-specific logic that does NOT belong in the adapter layer (per ADAPTER-01 decision). MODIFY it to read env vars INSIDE the function body instead of using the now-removed module-level vars. Specifically:
          - At the top of the delete_user_chunks function body, add:
            ```python
            supabase_url = os.getenv("SUPABASE_URL")
            supabase_service_key = os.getenv("SUPABASE_SERVICE_KEY")
            ```
          - Replace all references to module-level `SUPABASE_URL` with local `supabase_url`
          - Replace all references to module-level `SUPABASE_SERVICE_KEY` with local `supabase_service_key`
          **To be clear:** We are KEEPING this function and only changing WHERE it reads env vars from (module-level constants -> inline os.getenv() inside the function body). The function itself, its logic, and its httpx calls remain unchanged.

       d. REPLACE `from main import download_conversations` (line 140) with top-level import:
          Add `from adapters import download_conversations` at the module top, after other imports.
          Remove the inline `from main import download_conversations` on line 140.

       e. REPLACE `from main import update_user_profile` (line 185) with top-level import:
          Add `from adapters import update_user_profile` at the module top.
          Remove the inline `from main import update_user_profile` on line 185.

       f. ADD `from adapters import save_chunks_batch` at the module top (since local version removed).

       g. KEEP `import httpx` -- delete_user_chunks still uses httpx directly for its Supabase REST calls.

       h. The final import block at top of full_pass.py should look like:
          ```python
          import os
          import json
          import httpx
          import anthropic
          from datetime import datetime, timedelta
          from typing import List, Dict

          from adapters import download_conversations, update_user_profile, save_chunks_batch
          ```

       i. KEEP all processor-local imports (from processors.conversation_chunker, from processors.fact_extractor, etc.) -- these are already correct.

    3. Verify no references to `from main import` remain:
       ```bash
       grep -n "from main import" /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py
       ```
       Must return empty.

    4. Verify no module-level SUPABASE vars:
       ```bash
       grep -n "^SUPABASE_" /home/drewpullen/clawd/soulprint-rlm/processors/full_pass.py
       ```
       Must return empty.

    **Part B: Update Dockerfile**

    5. Edit /home/drewpullen/clawd/soulprint-rlm/Dockerfile. Insert BEFORE the `COPY main.py .` line:
       ```dockerfile
       # Copy adapters and processors (ordered by change frequency for layer caching)
       COPY adapters/ ./adapters/
       COPY processors/ ./processors/
       ```

    6. Insert AFTER the `COPY main.py .` line, BEFORE the HEALTHCHECK:
       ```dockerfile
       # Verify all modules import correctly at build time (fail fast)
       RUN python -c "from adapters import download_conversations, update_user_profile, save_chunks_batch; print('Adapters OK')" && \
           python -c "from processors.conversation_chunker import chunk_conversations; from processors.fact_extractor import extract_facts_parallel; from processors.memory_generator import generate_memory_section; from processors.v2_regenerator import regenerate_sections_v2; from processors.full_pass import run_full_pass_pipeline; print('Processors OK')"
       ```

    7. The final Dockerfile should have this order:
       - FROM, WORKDIR, RUN apt-get (existing)
       - COPY requirements.txt + RUN pip install (existing)
       - COPY adapters/ (NEW)
       - COPY processors/ (NEW)
       - COPY main.py (existing)
       - RUN python -c import verification (NEW)
       - HEALTHCHECK (existing)
       - EXPOSE + CMD (existing)
  </action>
  <verify>
    ```bash
    cd /home/drewpullen/clawd/soulprint-rlm
    # Verify full_pass.py imports correctly
    python -c "from processors.full_pass import run_full_pass_pipeline; print('full_pass OK')"

    # Verify no main imports remain
    grep "from main import" processors/full_pass.py && echo "FAIL: main imports found" || echo "PASS: no main imports"

    # Verify no module-level SUPABASE vars
    grep "^SUPABASE_" processors/full_pass.py && echo "FAIL: module-level vars found" || echo "PASS: no module-level vars"

    # Verify Dockerfile has COPY directives
    grep "COPY adapters/" Dockerfile && echo "PASS: adapters COPY found"
    grep "COPY processors/" Dockerfile && echo "PASS: processors COPY found"

    # Verify Dockerfile has import verification
    grep "from processors.full_pass import" Dockerfile && echo "PASS: import verification found"
    ```
  </verify>
  <done>full_pass.py imports from adapters (not main), has no module-level env vars, and Dockerfile copies both directories with build-time import verification.</done>
</task>

</tasks>

<verification>
Run all verification commands from both tasks:

```bash
cd /home/drewpullen/clawd/soulprint-rlm

# 1. All 5 processor modules importable
python -c "
from processors.conversation_chunker import chunk_conversations, estimate_tokens
from processors.fact_extractor import extract_facts_parallel, consolidate_facts, hierarchical_reduce
from processors.memory_generator import generate_memory_section
from processors.v2_regenerator import regenerate_sections_v2, sections_to_soulprint_text
from processors.full_pass import run_full_pass_pipeline
print('All processor imports OK')
"

# 2. No main.py imports in any processor
grep -r "from main import" processors/

# 3. No module-level SUPABASE vars
grep -rn "^SUPABASE_" processors/

# 4. full_pass.py imports from adapters
grep "from adapters import" processors/full_pass.py

# 5. 4 pure modules byte-identical to v1.2
diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/conversation_chunker.py processors/conversation_chunker.py
diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/fact_extractor.py processors/fact_extractor.py
diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/memory_generator.py processors/memory_generator.py
diff /home/drewpullen/clawd/soulprint-landing/rlm-service/processors/v2_regenerator.py processors/v2_regenerator.py

# 6. Dockerfile structure correct
grep -n "COPY" Dockerfile
```
</verification>

<success_criteria>
- 6 files exist in processors/ directory (5 modules + __init__.py)
- full_pass.py has `from adapters import download_conversations, update_user_profile, save_chunks_batch` at top
- full_pass.py has NO `from main import` statements
- full_pass.py has NO module-level `SUPABASE_URL` or `SUPABASE_SERVICE_KEY` variables
- delete_user_chunks reads env vars inside function body
- 4 pure modules are byte-identical to v1.2 source
- Dockerfile copies adapters/ and processors/ before main.py
- Dockerfile has RUN python -c import verification step
- `python -c "from processors.full_pass import run_full_pass_pipeline"` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-copy-modify-processors/02-01-SUMMARY.md`
</output>
