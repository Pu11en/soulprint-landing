---
phase: 02-cleanup-verification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/chunked-upload.ts
  - app/api/import/chunked-upload/route.ts
  - tests/integration/api/import/chunked-upload.test.ts
  - lib/api/schemas.ts
autonomous: true

must_haves:
  truths:
    - "Codebase contains zero references to old XHR upload functions (uploadWithProgress, chunkedUpload) in active TypeScript files"
    - "No chunked-upload API route exists in the app/api/import/ directory"
    - "chunkedUploadResultSchema export removed from lib/api/schemas.ts (no orphan schemas)"
    - "TypeScript compilation (npm run build) passes with no errors after file deletion"
    - "Test suite (npm run test) passes with no failures after test file removal"
  artifacts:
    - path: "lib/chunked-upload.ts"
      provides: "MUST NOT EXIST (deleted)"
    - path: "app/api/import/chunked-upload/route.ts"
      provides: "MUST NOT EXIST (deleted)"
    - path: "tests/integration/api/import/chunked-upload.test.ts"
      provides: "MUST NOT EXIST (deleted)"
  key_links:
    - from: "app/import/page.tsx"
      to: "lib/tus-upload.ts"
      via: "import { tusUpload }"
      pattern: "from.*@/lib/tus-upload"
---

<objective>
Remove the old XHR-based chunked upload code path that was replaced by TUS resumable uploads in Phase 1.

Purpose: Eliminate dead code that could confuse future development and falsely suggest an alternative upload path exists. Phase 1 fully migrated all uploads to TUS -- these files are unused orphans.

Output: Three files deleted (~610 lines removed), one orphan schema removed from lib/api/schemas.ts, clean build, passing tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cleanup-verification/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old XHR upload files and verify build</name>
  <files>
    lib/chunked-upload.ts
    app/api/import/chunked-upload/route.ts
    tests/integration/api/import/chunked-upload.test.ts
    lib/api/schemas.ts
  </files>
  <action>
Delete three files in this exact order with build verification between deletions:

1. Run a pre-deletion reference search to confirm no active imports exist:
   - `rg "from.*chunked-upload" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "uploadWithProgress|chunkedUpload" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "/api/import/chunked-upload" --type ts -g '!node_modules' -g '!.planning'`
   - Expected: Only matches in the three files being deleted. If ANY match appears in other active code, STOP and investigate before proceeding.

2. Delete `lib/chunked-upload.ts` (153 lines -- XHR upload utilities: uploadWithProgress, chunkedUpload, UploadProgress type, ProgressCallback type)

3. Delete `app/api/import/chunked-upload/route.ts` (190 lines -- server-side chunk assembly POST endpoint). Delete the entire `app/api/import/chunked-upload/` directory.

4. Edit `lib/api/schemas.ts` to remove the orphaned `chunkedUploadResultSchema` export and its comment block. Remove lines 192-199 (the comment block "Chunked Upload Result Schema" and the `z.object(...)` definition). Do NOT touch any other schema in the file.

5. Run `npm run build` to verify TypeScript compilation passes. If build fails, STOP -- a missed dependency exists.

6. Delete `tests/integration/api/import/chunked-upload.test.ts` (267 lines -- integration tests for removed API route)

7. Run `npm run test` to verify remaining tests pass. Test count should decrease by the number of tests in the deleted file but no OTHER tests should fail.

Do NOT modify any other files. Do NOT update documentation files. Do NOT touch lib/tus-upload.ts or app/import/page.tsx.
  </action>
  <verify>
- `ls lib/chunked-upload.ts` returns "No such file"
- `ls app/api/import/chunked-upload/` returns "No such file or directory"
- `ls tests/integration/api/import/chunked-upload.test.ts` returns "No such file"
- `rg "chunkedUploadResultSchema" lib/api/schemas.ts` returns zero results
- `npm run build` exits 0
- `npm run test` exits 0
  </verify>
  <done>
All three XHR upload files are deleted. chunkedUploadResultSchema removed from lib/api/schemas.ts. TypeScript build passes. All remaining tests pass. No broken imports or missing dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Post-deletion codebase verification</name>
  <files>
    (no files modified -- verification only)
  </files>
  <action>
Run comprehensive post-deletion verification to confirm zero orphaned references remain:

1. Search for ANY remaining reference to deleted code in active TypeScript/TSX files:
   - `rg "chunked-upload" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "uploadWithProgress" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "chunkedUpload" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "UploadProgress" --type ts -g '!node_modules' -g '!.planning'`
   - `rg "ProgressCallback" --type ts -g '!node_modules' -g '!.planning' -g '!lib/tus-upload.ts'`
   - `rg "chunkedUploadResultSchema" --type ts -g '!node_modules' -g '!.planning'`
   - ALL searches must return zero results in active code (matches in .md files, .planning/, or node_modules are expected and ignorable).

2. Verify the upload code path is intact by confirming `app/import/page.tsx` still imports from `lib/tus-upload.ts`:
   - `rg "from.*@/lib/tus-upload" app/import/page.tsx`
   - Must return at least one match.

3. Verify no API route directory remnants:
   - `ls app/api/import/` should NOT contain a `chunked-upload` directory.

4. Verify the import API surface is clean:
   - `ls app/api/import/` and confirm only expected routes remain (trigger, process-server, complete, etc.)
  </action>
  <verify>
- All grep searches for old XHR code return zero results in active TypeScript files
- `app/import/page.tsx` still imports `tusUpload` from `@/lib/tus-upload`
- `app/api/import/` directory has no `chunked-upload` subdirectory
  </verify>
  <done>
Zero orphaned references to old XHR upload code exist in the active codebase. TUS upload path confirmed intact. Cleanup is complete.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes (TypeScript compilation, no broken imports)
2. `npm run test` passes (no test regressions)
3. Zero matches for `chunked-upload|uploadWithProgress|chunkedUpload|chunkedUploadResultSchema` in active `.ts`/`.tsx` files
4. `app/import/page.tsx` imports `tusUpload` from `@/lib/tus-upload` (upload path intact)
5. Three target files no longer exist on disk
</verification>

<success_criteria>
- lib/chunked-upload.ts deleted (~153 lines removed)
- app/api/import/chunked-upload/ directory deleted (~190 lines removed)
- tests/integration/api/import/chunked-upload.test.ts deleted (~267 lines removed)
- npm run build exits 0
- npm run test exits 0 with no new failures
- chunkedUploadResultSchema removed from lib/api/schemas.ts
- No orphaned references to deleted code in active TypeScript files
</success_criteria>

<output>
After completion, create `.planning/phases/02-cleanup-verification/02-01-SUMMARY.md`
</output>
