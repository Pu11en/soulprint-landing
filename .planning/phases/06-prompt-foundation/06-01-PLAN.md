---
phase: 06-prompt-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/soulprint/prompt-helpers.ts
  - __tests__/unit/prompt-helpers.test.ts
autonomous: true

must_haves:
  truths:
    - "cleanSection() removes all 'not enough data' string values from section objects"
    - "cleanSection() removes empty arrays from section objects"
    - "cleanSection() returns null for sections where all values are empty/placeholder"
    - "formatSection() produces markdown with **Bold Label:** format for strings"
    - "formatSection() produces bullet lists for arrays"
    - "formatSection() never includes 'not enough data' in output"
    - "formatSection() output is deterministic (same input always produces same output)"
  artifacts:
    - path: "lib/soulprint/prompt-helpers.ts"
      provides: "Section validation and formatting helpers"
      exports: ["cleanSection", "formatSection"]
      min_lines: 40
    - path: "__tests__/unit/prompt-helpers.test.ts"
      provides: "Tests for section validation and formatting"
      min_lines: 80
  key_links:
    - from: "lib/soulprint/prompt-helpers.ts"
      to: "lib/soulprint/types.ts"
      via: "Section type imports"
      pattern: "import.*types"
---

<objective>
Create pure-function helpers for section validation (filter "not enough data" placeholders) and formatting (convert section objects to markdown), with full test coverage via TDD.

Purpose: These helpers are the shared foundation that both Next.js and RLM prompt builders will use. Getting them right and tested ensures prompt consistency (PROMPT-02) and prevents placeholder text in prompts (MEM-02).

Output: `lib/soulprint/prompt-helpers.ts` with `cleanSection()` and `formatSection()`, plus comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/PROMPT-ARCHITECTURE.md
@lib/soulprint/types.ts
@lib/soulprint/quick-pass.ts (lines 96-122 — existing sectionToMarkdown)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for cleanSection and formatSection</name>
  <files>__tests__/unit/prompt-helpers.test.ts</files>
  <action>
Create test file `__tests__/unit/prompt-helpers.test.ts` that imports `cleanSection` and `formatSection` from `lib/soulprint/prompt-helpers`.

**cleanSection tests:**
1. Returns cleaned object with "not enough data" strings removed:
   - Input: `{ name: "Drew", location: "not enough data", occupation: "Engineer" }`
   - Expected: `{ name: "Drew", occupation: "Engineer" }`

2. Returns cleaned object with empty arrays removed:
   - Input: `{ interests: [], relationships: ["friend named Alex"], name: "Drew" }`
   - Expected: `{ relationships: ["friend named Alex"], name: "Drew" }`

3. Returns null when ALL values are placeholder/empty:
   - Input: `{ name: "not enough data", location: "not enough data", interests: [] }`
   - Expected: `null`

4. Preserves valid arrays and strings:
   - Input: `{ personality_traits: ["curious", "direct"], communication_style: "Casual and concise" }`
   - Expected: Same object returned unchanged

5. Handles case-insensitive "Not Enough Data" / "NOT ENOUGH DATA":
   - Input: `{ name: "Not Enough Data", location: "NOT ENOUGH DATA" }`
   - Expected: `null`

6. Filters empty strings and whitespace-only strings:
   - Input: `{ name: "Drew", location: "", occupation: "   " }`
   - Expected: `{ name: "Drew" }`

7. Filters arrays containing only "not enough data" items:
   - Input: `{ traits: ["not enough data"], name: "Drew" }`
   - Expected: `{ name: "Drew" }`

**formatSection tests:**
1. Formats string values with bold labels:
   - Input: `formatSection("Communication Style & Personality", { communication_style: "Direct and casual" })`
   - Expected output contains: `**Communication Style:** Direct and casual`

2. Formats arrays as bullet lists:
   - Input: `formatSection("About This Person", { interests: ["AI", "crypto", "privacy"] })`
   - Expected output contains: `**Interests:**\n- AI\n- crypto\n- privacy`

3. Converts underscore_keys to Title Case labels:
   - Input: key `tone_preferences` → label `Tone Preferences`

4. Includes section heading:
   - Output starts with `## Communication Style & Personality`

5. Never includes "not enough data" in output (if cleanSection wasn't called first):
   - Input with `{ name: "not enough data", occupation: "Engineer" }`
   - Output does NOT contain "not enough data"

6. Returns empty string for null/empty input:
   - Input: `formatSection("Test", null)` → `""`
   - Input: `formatSection("Test", {})` → `""`

Run tests: `npx vitest run __tests__/unit/prompt-helpers.test.ts` — ALL tests should FAIL (module doesn't exist yet).
  </action>
  <verify>npx vitest run __tests__/unit/prompt-helpers.test.ts 2>&1 | grep -E "FAIL|fail|error" — tests fail because module doesn't exist</verify>
  <done>Test file exists with 13+ test cases covering validation and formatting. All tests fail.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN + REFACTOR — Implement cleanSection and formatSection</name>
  <files>lib/soulprint/prompt-helpers.ts</files>
  <action>
Create `lib/soulprint/prompt-helpers.ts` with two exported functions:

**cleanSection(data: Record&lt;string, unknown&gt; | null): Record&lt;string, unknown&gt; | null**
- If data is null/undefined, return null
- Iterate all key-value pairs
- For string values: remove if empty, whitespace-only, or matches "not enough data" (case-insensitive)
- For array values: filter out "not enough data" items, then remove if array is empty
- After filtering, if no keys remain, return null
- Return cleaned object

**formatSection(sectionName: string, data: Record&lt;string, unknown&gt; | null): string**
- If data is null or empty object, return empty string ""
- Start with `## ${sectionName}` heading
- For each key-value pair in data:
  - Convert key from snake_case to Title Case (replace _ with space, capitalize each word)
  - If value is string: skip if empty/whitespace/"not enough data" (defensive, even if cleanSection was called). Add `**${label}:** ${value}`
  - If value is array with items: Add `**${label}:**` then each item as `- ${item}` on new lines. Skip empty arrays and filter "not enough data" items.
- Join all lines with `\n`
- Return the formatted string

**IMPORTANT formatting rules (must match exactly for PROMPT-02 consistency):**
- Section heading: `## ${sectionName}` (with ##, space, then name)
- String fields: `**${TitleCase Label}:** ${value}`
- Array fields: `**${TitleCase Label}:**\n- item1\n- item2`
- Empty/placeholder values: skip entirely (no line generated)
- This format replaces the existing sectionToMarkdown() from quick-pass.ts for prompt composition. The existing function will remain for backward compatibility (used in sectionsToSoulprintText for storage), but the NEW formatSection should be used for prompt building.

Run tests: `npx vitest run __tests__/unit/prompt-helpers.test.ts` — ALL tests should PASS.
  </action>
  <verify>npx vitest run __tests__/unit/prompt-helpers.test.ts — all tests pass</verify>
  <done>cleanSection and formatSection implemented, all 13+ tests pass, functions exported from lib/soulprint/prompt-helpers.ts</done>
</task>

</tasks>

<verification>
1. `npx vitest run __tests__/unit/prompt-helpers.test.ts` — all tests pass
2. `npx tsc --noEmit lib/soulprint/prompt-helpers.ts` — no type errors
3. Manual check: formatSection output with sample SOUL section matches expected markdown format
</verification>

<success_criteria>
- cleanSection filters "not enough data" (case-insensitive), empty strings, empty arrays
- cleanSection returns null for fully-empty sections
- formatSection produces markdown with **Bold:** labels, bullet lists for arrays
- formatSection never outputs "not enough data"
- All tests pass
- Functions exported and importable from lib/soulprint/prompt-helpers
</success_criteria>

<output>
After completion, create `.planning/phases/06-prompt-foundation/06-01-SUMMARY.md`
</output>
