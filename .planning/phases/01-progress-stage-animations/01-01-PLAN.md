---
phase: 01-progress-stage-animations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/import/progress-mapper.ts
  - lib/import/progress-mapper.test.ts
  - components/import/animated-progress-stages.tsx
autonomous: true

must_haves:
  truths:
    - "Progress mapper converts backend progress_percent + import_stage to a frontend stage (1-4) with display percentage"
    - "Progress never decreases — monotonic guard rejects any value lower than last known"
    - "Stage indicator component renders 4 stages with active/complete/pending states"
    - "Active stage shows pulsing animation to prevent stalled appearance"
    - "Stage transitions animate with 300ms fade + slide via Framer Motion"
  artifacts:
    - path: "lib/import/progress-mapper.ts"
      provides: "Pure function mapping backend milestones to frontend stages"
      exports: ["mapProgress", "STAGES", "StageInfo"]
    - path: "lib/import/progress-mapper.test.ts"
      provides: "Unit tests for progress mapper"
      contains: "monotonic"
    - path: "components/import/animated-progress-stages.tsx"
      provides: "Animated stage-based progress UI component"
      exports: ["AnimatedProgressStages"]
  key_links:
    - from: "lib/import/progress-mapper.ts"
      to: "components/import/animated-progress-stages.tsx"
      via: "mapProgress function called by component"
      pattern: "mapProgress"
---

<objective>
Create the progress mapper (pure function) and animated stage indicator component for import progress.

Purpose: These are the foundational building blocks for the stage-based progress UI. The mapper converts raw backend data (progress_percent, import_stage) into a structured frontend stage model with monotonic enforcement. The component renders the 4-stage visual indicator with animations.

Output: Two new files — a pure logic module with tests, and a React component ready for integration into import/page.tsx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY-PROGRESS-UX.md
@app/import/page.tsx
@components/ui/ring-progress.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Progress mapper with monotonic guard and stage mapping</name>
  <files>lib/import/progress-mapper.ts, lib/import/progress-mapper.test.ts</files>
  <action>
Create `lib/import/progress-mapper.ts` — a pure function module (no React, no side effects) that maps backend progress to frontend stages.

**Stage definitions (STAGES constant array):**
- Stage 1: "Upload" — icon: Upload, range: 0-50%
- Stage 2: "Extract" — icon: FileArchive, range: 50-60%
- Stage 3: "Analyze" — icon: Brain/Sparkles, range: 60-80%
- Stage 4: "Build Profile" — icon: User/Fingerprint, range: 80-100%

**StageInfo type:**
```typescript
interface StageInfo {
  stageIndex: number;       // 0-3 (which stage we're in)
  stageLabel: string;       // "Upload", "Extract", etc.
  displayPercent: number;   // The percentage to show (0-100)
  isComplete: boolean;      // All stages done (100%)
  safeToClose: boolean;     // True when past upload phase (progress >= 55)
}
```

**mapProgress function:**
```typescript
function mapProgress(
  backendPercent: number,
  backendStage: string | null,
  lastKnownPercent: number  // For monotonic guard
): StageInfo
```

**Logic:**
1. Monotonic guard: If backendPercent < lastKnownPercent, use lastKnownPercent instead (never go backwards)
2. Clamp to 0-100 range
3. Determine stageIndex from the effective percent:
   - 0-49: stageIndex 0 (Upload)
   - 50-59: stageIndex 1 (Extract)
   - 60-79: stageIndex 2 (Analyze)
   - 80-100: stageIndex 3 (Build Profile)
4. Map backend stage strings to better display labels:
   - "Downloading export" / "Uploading..." / null with percent < 50 → "Uploading your data..."
   - "Parsing conversations" → "Extracting conversations..."
   - "Generating soulprint" → "Analyzing your personality..."
   - "Building profile" → "Building your SoulPrint..."
   - For percent === 100 → "Complete!"
   - Default: use the backend stage string or generic "Processing..."
5. safeToClose: effectivePercent >= 55
6. isComplete: effectivePercent >= 100

Also export a helper: `getStageProgress(stageIndex: number, overallPercent: number): number` that returns 0-100 for how far through the CURRENT stage we are (for the inner progress bar within a stage). Example: if overall is 70% and we're in Analyze (60-80%), stage progress = (70-60)/(80-60)*100 = 50%.

**Tests (lib/import/progress-mapper.test.ts):**
Write Vitest tests covering:
- Monotonic guard: mapProgress(50, null, 60) returns percent >= 60
- Stage boundaries: 49 → stage 0, 50 → stage 1, 60 → stage 2, 80 → stage 3
- Clamp: -5 → 0, 150 → 100
- Backend stage string mapping (each of the 4 mapped strings)
- safeToClose threshold at 55
- isComplete at 100
- getStageProgress calculations
- Edge case: 0% → stage 0, 100% → stage 3 + isComplete
  </action>
  <verify>Run `npx vitest run lib/import/progress-mapper.test.ts` — all tests pass</verify>
  <done>progress-mapper.ts exports mapProgress, STAGES, StageInfo, getStageProgress. All tests pass. Monotonic guard proven by test.</done>
</task>

<task type="auto">
  <name>Task 2: Animated progress stages component</name>
  <files>components/import/animated-progress-stages.tsx</files>
  <action>
Create `components/import/animated-progress-stages.tsx` — a React component that renders the 4-stage progress indicator with Framer Motion animations.

**Props:**
```typescript
interface AnimatedProgressStagesProps {
  progress: number;          // 0-100 overall progress
  stage: string | null;      // Backend stage string
  lastKnownPercent: number;  // For monotonic guard (passed to mapProgress)
}
```

**Component structure (top to bottom):**

1. **Stage stepper (horizontal row):** 4 circles connected by lines.
   - Each circle: 32x32px, with icon inside (use Lucide icons: Upload, FileSearch, Sparkles, Fingerprint)
   - Completed stages: orange background (`bg-orange-500`), white icon, checkmark overlay
   - Active stage: orange border (`border-orange-500`), orange icon, pulsing glow animation
   - Pending stages: white/10 background, white/30 icon
   - Connecting lines between circles: completed = orange, pending = white/10
   - Stage labels below each circle: text-xs, white for active/complete, white/40 for pending
   - Use Framer Motion `AnimatePresence` + `motion.div` for transitions between states (300ms)
   - Active stage circle has `animate={{ scale: [1, 1.05, 1] }}` with `repeat: Infinity, duration: 2` for subtle pulse

2. **Current stage message:** Below the stepper
   - Uses the `stageLabel` from mapProgress
   - Animated with Framer Motion `key={stageLabel}` so it fades when label changes
   - `initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }}` transition 300ms

3. **Progress bar:** Full width below message
   - Track: `h-1.5 bg-white/10 rounded-full`
   - Fill: `bg-gradient-to-r from-orange-600 to-orange-400 rounded-full`
   - Animated width with Framer Motion: `animate={{ width: displayPercent + '%' }}` transition 500ms ease-out
   - Active shimmer: Add a subtle shimmer overlay on the filled portion using CSS animation (Tailwind `animate-pulse` on a white/20 overlay inside the bar) to indicate ongoing work — this satisfies PROG-03

4. **Percentage display:** Right-aligned below progress bar
   - `text-sm font-semibold text-white/70`
   - Animated number change (simple — just render `Math.round(displayPercent)%`)

5. **Context message:** Below percentage
   - If safeToClose: green text "Safe to close this tab — processing continues in the background"
   - If not safeToClose and progress < 50: orange text "Large exports can take a few minutes — please keep this tab open"
   - Else: orange text "Please keep this tab open until upload completes"

**Performance considerations (per research PITFALLS):**
- NO SVG drop-shadow filters (kills mobile perf). Use solid borders/backgrounds only.
- Add `will-change: transform` on animated elements via Framer Motion's `style` prop
- Keep animations to opacity + transform only (GPU-composited)
- Use `layoutId` on stage circles for smooth layout transitions if stages resize

**Styling:** Match the existing dark theme — black background, orange-500 accent, white text, white/10 borders. Component should look at home in the existing import page which uses `bg-black` with `BackgroundBeams`.

Import `mapProgress`, `STAGES`, `getStageProgress` from `@/lib/import/progress-mapper`. The component calls `mapProgress(progress, stage, lastKnownPercent)` internally and renders based on the result.

The component should be `max-w-md w-full` to match the existing processing section width.
  </action>
  <verify>Run `npm run build` — no TypeScript errors. Visually inspect that the component file exports AnimatedProgressStages and imports from progress-mapper correctly.</verify>
  <done>AnimatedProgressStages component exists, imports from progress-mapper, renders 4-stage stepper with Framer Motion animations, pulsing active stage, shimmer progress bar, and context messages. No SVG drop-shadow filters used.</done>
</task>

</tasks>

<verification>
- `npx vitest run lib/import/progress-mapper.test.ts` — all tests pass
- `npm run build` — no TypeScript errors
- `components/import/animated-progress-stages.tsx` exports AnimatedProgressStages
- `lib/import/progress-mapper.ts` exports mapProgress, STAGES, StageInfo, getStageProgress
- No new dependencies added to package.json
</verification>

<success_criteria>
- Progress mapper correctly converts backend percent/stage to frontend stage model
- Monotonic guard prevents progress from ever decreasing
- Stage component renders 4 visual stages with active/complete/pending states
- Active stage has pulsing animation (PROG-03: never appears stalled)
- Stage transitions use 300ms Framer Motion animation (PROG-02)
- No SVG drop-shadow filters (PROG-04: mobile performance)
- All unit tests pass
- Build succeeds with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-progress-stage-animations/01-01-SUMMARY.md`
</output>
