---
phase: 01-progress-stage-animations
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app/import/page.tsx
  - components/ui/ring-progress.tsx
autonomous: false

must_haves:
  truths:
    - "User sees 4 animated stage indicators (Upload, Extract, Analyze, Build Profile) during import processing"
    - "Stage transitions animate smoothly (300ms fade + slide) when progress moves between stages"
    - "Active stage shows pulsing animation — progress never appears stalled"
    - "Progress percentage never jumps backwards during import (monotonic enforcement)"
    - "Mobile devices render progress without jank (no SVG drop-shadow filter)"
  artifacts:
    - path: "app/import/page.tsx"
      provides: "Import page with stage-based progress replacing old RingProgress processing UI"
      contains: "AnimatedProgressStages"
    - path: "components/ui/ring-progress.tsx"
      provides: "Mobile-safe ring progress (drop-shadow removed)"
  key_links:
    - from: "app/import/page.tsx"
      to: "components/import/animated-progress-stages.tsx"
      via: "import and render in processing phase"
      pattern: "AnimatedProgressStages"
    - from: "app/import/page.tsx"
      to: "lib/import/progress-mapper.ts"
      via: "monotonic guard in polling and handleFile"
      pattern: "lastKnownPercent|mapProgress"
---

<objective>
Integrate the new animated progress stages component into import/page.tsx, replacing the old processing UI. Wire up monotonic progress tracking through both the client-side handleFile flow and the server-side polling flow.

Purpose: This connects the building blocks from Plan 01 to the actual import page, delivering the visual stage-based progress experience users see during import. Also fixes the RingProgress mobile performance issue (drop-shadow filter removal).

Output: Import page displays animated 4-stage progress with monotonic enforcement. Mobile-safe rendering confirmed.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY-PROGRESS-UX.md
@.planning/phases/01-progress-stage-animations/01-01-SUMMARY.md
@app/import/page.tsx
@components/ui/ring-progress.tsx
@components/import/animated-progress-stages.tsx
@lib/import/progress-mapper.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate AnimatedProgressStages into import page + monotonic guard</name>
  <files>app/import/page.tsx, components/ui/ring-progress.tsx</files>
  <action>
Modify `app/import/page.tsx` to use the new stage-based progress UI. This replaces the current processing phase rendering (lines 387-404) with the AnimatedProgressStages component.

**Changes to import/page.tsx:**

1. **Add imports:**
   ```typescript
   import { AnimatedProgressStages } from '@/components/import/animated-progress-stages';
   ```
   Remove the `RingProgress` import (no longer used in this file).

2. **Add lastKnownPercent ref for monotonic guard:**
   ```typescript
   const lastKnownPercentRef = useRef(0);
   ```
   This persists across re-renders but resets on unmount (new import session).

3. **Update startPolling (lines 37-67):**
   Wrap the `setProgress` call with the monotonic guard:
   ```typescript
   const newPercent = data.progress_percent || 0;
   const effectivePercent = Math.max(newPercent, lastKnownPercentRef.current);
   lastKnownPercentRef.current = effectivePercent;
   setProgress(effectivePercent);
   setStage(data.import_stage || 'Processing...');
   ```
   This ensures progress NEVER goes backwards from the polling data. The ref persists the high-water mark across poll intervals.

4. **Update handleFile progress calls:**
   Everywhere `setProgress(X)` is called in handleFile, also update the ref:
   ```typescript
   // Before each setProgress call:
   lastKnownPercentRef.current = Math.max(X, lastKnownPercentRef.current);
   setProgress(lastKnownPercentRef.current);
   ```
   Apply this to: line 162 (setProgress(10)), line 172/178 (setProgress(5)), line 191 (setProgress(10 + ...)), line 205 (setProgress(55)).

5. **Update init function (lines 91-96):**
   When resuming a processing state, also set the ref:
   ```typescript
   const resumePercent = data.progress_percent ?? 0;
   lastKnownPercentRef.current = resumePercent;
   setProgress(resumePercent);
   ```

6. **Replace processing phase JSX (lines 387-404):**
   Replace the entire `{phase === 'processing' && (...)}` block with:
   ```tsx
   {phase === 'processing' && (
     <motion.div key="processing" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="w-full max-w-md">
       <AnimatedProgressStages
         progress={progress}
         stage={stage}
         lastKnownPercent={lastKnownPercentRef.current}
       />
     </motion.div>
   )}
   ```
   This delegates ALL processing UI to the new component. The motion.div wrapper preserves the AnimatePresence fade behavior for entering/exiting the processing phase.

7. **Reset lastKnownPercent on new import:**
   At the start of handleFile, reset: `lastKnownPercentRef.current = 0;`
   This ensures a re-import starts fresh.

**Changes to components/ui/ring-progress.tsx:**
Remove the `drop-shadow` filter from the progress circle's style prop (line 58-59):
```typescript
// Remove this:
style={{
  filter: `drop-shadow(0 0 6px ${color}50)`,
}}
// Replace with nothing (just remove the style prop)
```
This fixes mobile performance per research pitfall #6. The RingProgress component may still be used elsewhere, so keep the file but make it mobile-safe. The import page no longer uses it, but it shouldn't be deleted since other pages might reference it.
  </action>
  <verify>
Run `npm run build` — no TypeScript errors.
Run `npm run dev` and navigate to /import. Upload a test file and verify:
1. Stage stepper appears with 4 stages during processing
2. Progress percentage increases monotonically
3. Active stage pulses
4. Stage transitions animate smoothly
  </verify>
  <done>
Import page uses AnimatedProgressStages component for processing phase. Monotonic progress guard applied via lastKnownPercentRef in both handleFile and polling flows. RingProgress drop-shadow removed for mobile safety. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Stage-based animated progress UI for the import flow. Four stages (Upload, Extract, Analyze, Build Profile) with animated transitions, pulsing active stage, shimmer progress bar, and monotonic progress enforcement. Mobile-safe (no SVG drop-shadow).</what-built>
  <how-to-verify>
1. Deploy to Vercel (push to main) or run `npm run dev` locally
2. Go to /import (or /import?reimport=true if you already have data)
3. Upload a ChatGPT export ZIP file
4. During upload phase (0-50%), verify:
   - Stage 1 (Upload) is highlighted/active with pulsing animation
   - Progress bar moves smoothly, percentage increases
   - Stages 2-4 appear as pending (dimmed)
5. After upload completes and polling starts (50%+), verify:
   - Stage transitions animate (fade + slide) when moving from Upload to Extract to Analyze
   - Active stage always shows pulse animation (never looks frozen)
   - Progress percentage NEVER jumps backwards
   - "Safe to close" message appears after 55%
6. Test on mobile (iOS Safari or Android Chrome):
   - Stage indicators render without visual lag/jank
   - No SVG artifacts or blurry shadows
   - Layout doesn't shift when stages transition
7. When complete (100%), verify stage 4 shows as complete with all stages checked off
  </how-to-verify>
  <resume-signal>Type "approved" if the stage-based progress looks good on desktop and mobile, or describe any visual issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- Import page renders AnimatedProgressStages during processing phase
- Progress never decreases (monotonic guard in polling + handleFile)
- RingProgress component no longer has drop-shadow filter
- Stage transitions animate with Framer Motion
- Active stage has pulsing animation
- Mobile rendering is jank-free (no SVG filters)
</verification>

<success_criteria>
- PROG-01: User sees animated stage indicators (Upload, Extract, Analyze, Build Profile) during import
- PROG-02: Each stage has visual transition animation (300ms fade + slide) when moving to next stage
- PROG-03: Progress never appears stalled — active stages show pulsing/shimmer animation
- PROG-04: Stage indicators work smoothly on mobile (no SVG drop-shadow, no layout shift)
- Progress percentage is monotonic (never jumps backwards) throughout entire import flow
- Human verifies visual quality on desktop and mobile
</success_criteria>

<output>
After completion, create `.planning/phases/01-progress-stage-animations/01-02-SUMMARY.md`
</output>
