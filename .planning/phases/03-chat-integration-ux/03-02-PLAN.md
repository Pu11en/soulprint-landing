---
phase: 03-chat-integration-ux
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/memory/status/route.ts
  - app/import/page.tsx
autonomous: true

must_haves:
  truths:
    - "After uploading a ChatGPT export, the user sees an 'Analyzing your conversations...' loading screen that resolves when quick pass sections are ready"
    - "Import page redirects to /chat when import_status becomes 'quick_ready'"
    - "Memory status endpoint returns full_pass_status for downstream consumers"
  artifacts:
    - path: "app/api/memory/status/route.ts"
      provides: "full_pass_status in API response"
      contains: "full_pass_status"
    - path: "app/import/page.tsx"
      provides: "Loading screen with 'Analyzing your conversations...' and redirect on quick_ready"
      contains: "quick_ready"
  key_links:
    - from: "app/import/page.tsx"
      to: "/api/memory/status"
      via: "polling to detect quick_ready"
      pattern: "quick_ready.*router.push.*chat"
    - from: "app/api/memory/status/route.ts"
      to: "user_profiles.full_pass_status"
      via: "database SELECT"
      pattern: "full_pass_status"
---

<objective>
Update the memory status endpoint to expose full_pass_status and refactor the import page to show an "Analyzing your conversations..." loading screen that transitions to /chat when the quick pass completes.

Purpose: Users currently see "Complete! We'll email you when ready." after upload and are told to close the page. With v1.2's quick pass (~15-30s), users should instead see a loading screen and then be redirected to /chat immediately. The memory status endpoint also needs to return full_pass_status for the chat page (Plan 03) to show a memory progress indicator.
Output: Updated memory status endpoint + refactored import page UX.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-chat-integration-ux/03-RESEARCH.md

@app/api/memory/status/route.ts
@app/import/page.tsx
@app/api/import/process-server/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add full_pass_status to memory status endpoint</name>
  <files>app/api/memory/status/route.ts</files>
  <action>
Update the SELECT query (line 23) to include `full_pass_status`:

Change:
```typescript
.select('import_status, import_error, processing_started_at, total_conversations, total_messages, soulprint_generated_at, soulprint_locked, locked_at, embedding_status, embedding_progress, total_chunks, processed_chunks, memory_status')
```
To:
```typescript
.select('import_status, import_error, processing_started_at, total_conversations, total_messages, soulprint_generated_at, soulprint_locked, locked_at, embedding_status, embedding_progress, total_chunks, processed_chunks, memory_status, full_pass_status, full_pass_error')
```

Add `full_pass_status` and `full_pass_error` to the JSON response (around line 40):
```typescript
fullPassStatus: profile?.full_pass_status || 'pending',
fullPassError: profile?.full_pass_error || null,
```

Also update the `hasSoulprint` check (line 32) to treat 'quick_ready' as having a soulprint:
```typescript
const hasSoulprint = isLocked || profile?.import_status === 'complete' || profile?.import_status === 'quick_ready';
```
This is already correct -- just verify it's there.

The `status` mapping (line 35) should NOT return 'processing' when import_status is 'quick_ready'. Currently it maps 'quick_ready' to 'ready' (via `hasSoulprint`), which is correct. Verify this logic is correct:
- import_status='none' -> status='none'
- import_status='processing' -> status='processing'
- import_status='quick_ready' -> status='ready' (chat allowed, full pass running in background)
- import_status='complete' -> status='ready'
- import_status='failed' -> status='failed'
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors</verify>
  <done>Memory status endpoint returns fullPassStatus and fullPassError. 'quick_ready' correctly maps to status='ready'.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor import page to show loading screen and redirect on quick_ready</name>
  <files>app/import/page.tsx</files>
  <action>
The import page currently shows "Complete! We'll email you when ready." after processing and tells users to close the page. Refactor the "done" step to instead:

1. **After `queue-processing` returns success** (around line 437-444):
   Instead of showing the "done" step with email message, start polling `/api/memory/status` to wait for `import_status = 'quick_ready'`. The process-server sets `import_status = 'quick_ready'` after the quick pass completes and before it fires the RLM full pass.

   Replace the current success block:
   ```typescript
   // OLD:
   setProgressStage('Complete! We\'ll email you when ready.');
   setProgress(100);
   setStatus('success');
   setCurrentStep('done');
   ```

   With a polling loop that waits for quick_ready:
   ```typescript
   setProgressStage('Analyzing your conversations...');
   setProgress(85);

   // Poll for quick_ready status
   const pollForReady = async () => {
     const maxAttempts = 60; // 60 attempts * 2s = 120s max wait
     let attempts = 0;

     while (attempts < maxAttempts) {
       attempts++;
       await new Promise(r => setTimeout(r, 2000)); // 2s interval

       try {
         const statusRes = await fetch('/api/memory/status');
         if (!statusRes.ok) continue;
         const statusData = await statusRes.json();

         if (statusData.status === 'ready' || statusData.hasSoulprint) {
           // Quick pass complete -- redirect to chat!
           setProgress(100);
           setProgressStage('Analysis complete! Opening chat...');
           await new Promise(r => setTimeout(r, 500)); // Brief pause for UX
           router.push('/chat');
           return;
         }

         if (statusData.status === 'failed') {
           throw new Error(statusData.import_error || 'Processing failed');
         }

         // Still processing -- update progress text
         if (attempts < 15) {
           setProgressStage('Analyzing your conversations...');
         } else if (attempts < 30) {
           setProgressStage('Building your personality profile...');
         } else {
           setProgressStage('Almost there...');
         }
         setProgress(Math.min(85 + Math.floor(attempts * 0.2), 98));
       } catch (pollErr) {
         console.error('[Import] Status poll error:', pollErr);
         // Continue polling on network errors
       }
     }

     // Timeout -- still redirect to chat (quick pass should be done by now)
     router.push('/chat');
   };

   await pollForReady();
   ```

   IMPORTANT: The `queue-processing` endpoint calls `process-server` synchronously and returns AFTER the quick pass is done. So by the time we get the success response, `import_status` should already be `'quick_ready'`. The polling is a safety net. In practice, the first poll should detect `quick_ready` immediately. So we can simplify: after queue-processing returns success, immediately redirect:

   ```typescript
   // Process-server already completed quick pass and set import_status='quick_ready'
   setProgressStage('Analysis complete! Opening chat...');
   setProgress(100);
   await new Promise(r => setTimeout(r, 800)); // Brief pause for UX
   router.push('/chat');
   ```

   Use this simpler approach. The queue-processing response already means quick pass is done.

2. **Update the "done" step UI** (around line 813-839):
   Replace the current "Upload Complete!" / "We'll email you when it's ready!" content with a brief transition screen. Since we're redirecting immediately after success, this screen may flash briefly or not show at all. Keep it as a fallback:

   ```tsx
   {currentStep === 'done' && (
     <motion.div ...>
       <div className="w-14 h-14 ...">
         <CheckCircle2 className="w-7 h-7 text-green-500" />
       </div>
       <h2>Analysis Complete!</h2>
       <p>Opening your personalized chat...</p>
       <div className="w-6 h-6 border-2 border-[#EA580C] border-t-transparent rounded-full animate-spin" />
     </motion.div>
   )}
   ```

   Remove the email-related UI (the Mail icon, "We'll email you when it's ready!" text, and "You can close this page" text).

3. **Update the processing step text** (around line 785-786):
   Change "Creating your SoulPrint" to "Analyzing your conversations..." to match the requirement IMP-01.

4. **Update the progress stage messages** in the progress animation interval (around lines 385-393):
   Change the stage text to be about analysis rather than SoulPrint creation:
   - `< 65` -> 'Downloading and extracting...'
   - `< 75` -> 'Reading your conversations...'
   - `< 85` -> 'Analyzing your personality...'
   - else -> 'Building your profile...'

5. **Ensure the existing redirect logic** (around lines 176-185) correctly handles `quick_ready`:
   The check at line 176 already redirects to /chat if `data.status === 'ready'` or `data.hasSoulprint`, which covers `quick_ready`. Verify this is correct by confirming the memory status endpoint maps `import_status='quick_ready'` to `status='ready'`.
  </action>
  <verify>
Run `npm run build` -- builds successfully.
Verify the import page no longer references email notifications (grep for "email" and "Mail" in import/page.tsx).
  </verify>
  <done>
Import page shows "Analyzing your conversations..." during processing and redirects to /chat immediately after queue-processing completes (quick pass done). No more "We'll email you" messaging. Done step shows brief transition instead of email wait.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. Memory status endpoint returns `fullPassStatus` field
3. Import page no longer shows "We'll email you when ready" messaging
4. Import page redirects to /chat after successful processing
5. No references to email notification in import page
</verification>

<success_criteria>
- After upload, user sees "Analyzing your conversations..." loading screen (IMP-01)
- Chat opens after quick pass completes -- redirected from import page (IMP-02)
- Memory status endpoint returns full_pass_status for chat page to consume (IMP-03, IMP-04 setup)
- No "SoulPrint is ready" email messaging shown in import flow
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-integration-ux/03-02-SUMMARY.md`
</output>
