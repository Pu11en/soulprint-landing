---
phase: 03-chat-integration-ux
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - app/chat/page.tsx
  - lib/email/send.ts
autonomous: true

must_haves:
  truths:
    - "While background processing runs, chat shows a memory progress indicator; after full pass completes, indicator disappears"
    - "Chat page gates access based on import_status -- redirects to /import if 'none' or 'processing'"
    - "No 'SoulPrint is ready' email function exists in the codebase"
    - "After full pass completes, sections silently upgrade to v2 on next message (no user action needed)"
  artifacts:
    - path: "app/chat/page.tsx"
      provides: "Memory progress indicator based on full_pass_status, import gating"
      contains: "fullPassStatus"
    - path: "lib/email/send.ts"
      provides: "Email utility without sendSoulprintReadyEmail"
  key_links:
    - from: "app/chat/page.tsx"
      to: "/api/memory/status"
      via: "polling for fullPassStatus"
      pattern: "fullPassStatus"
    - from: "app/chat/page.tsx"
      to: "/import"
      via: "redirect when import not ready"
      pattern: "router.push.*import"
---

<objective>
Update the chat page to show a memory progress indicator based on full_pass_status, properly gate access on import_status, and clean up the unused email function.

Purpose: Users arriving at /chat after quick pass should see a subtle memory progress banner ("Building deep memory...") while the full pass runs in the background. When full pass completes, the banner disappears and all sections silently upgrade to v2. Also removes the dead sendSoulprintReadyEmail function to satisfy EMAIL-01.
Output: Updated chat page with proper import gating + memory progress, cleaned email module.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-chat-integration-ux/03-RESEARCH.md
@.planning/phases/03-chat-integration-ux/03-02-SUMMARY.md

@app/chat/page.tsx
@app/api/memory/status/route.ts
@lib/email/send.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor chat page polling to use full_pass_status for memory progress</name>
  <files>app/chat/page.tsx</files>
  <action>
Rewrite the memory status polling useEffect (lines 124-194) to properly handle the v1.2 import flow:

1. **Import gating logic** -- The current code redirects to /import when `!data.hasSoulprint && data.status === 'none'`. This is correct but needs to also handle 'processing':
   - `status === 'none'` and no soulprint -> redirect to /import
   - `status === 'processing'` and no soulprint -> redirect to /import (they need to be on the import page to see the loading screen)
   - `status === 'ready'` -> allow chat (covers both 'quick_ready' and 'complete')
   - `status === 'failed'` -> show error with retry link to /import

2. **Memory progress based on full_pass_status** -- After import gating passes (status === 'ready'), use `fullPassStatus` from the response:
   - `fullPassStatus === 'pending'` -> show "Preparing deep memory..." (full pass hasn't started yet)
   - `fullPassStatus === 'processing'` -> show "Building deep memory..." with subtle indicator
   - `fullPassStatus === 'complete'` -> hide progress indicator, set memoryStatus to 'ready'
   - `fullPassStatus === 'failed'` -> hide progress indicator (non-fatal per decision 02-03), log warning

3. **Stop polling once complete** -- When both `status === 'ready'` AND `fullPassStatus === 'complete'`, stop the interval (no more polling needed). Add a ref to track whether to continue polling:
   ```typescript
   const shouldPollRef = useRef(true);
   ```
   Set it to false when fully complete. In the interval callback, check `shouldPollRef.current` before fetching.

4. **Replace the existing memoryStatus state machine** -- The current implementation uses 'loading', 'processing', 'ready', 'failed', 'none' for memoryStatus. Simplify to focus on full_pass_status:
   - `memoryStatus: 'building'` -- full pass is pending or processing (show indicator)
   - `memoryStatus: 'ready'` -- full pass complete (hide indicator)
   - `memoryStatus: 'failed'` -- import failed (show error)
   - `memoryStatus: 'none'` -- no import (redirect)

   The existing memoryProgress percentage state can be simplified. Since the RLM full pass doesn't report percentage progress, use an indeterminate indicator instead of a percentage. Remove the `memoryProgress` state or keep it for future use but don't display a percentage.

5. **Update the progress indicator UI** (lines 588-597) to show the new memory building status:
   ```tsx
   {memoryStatus === 'building' && (
     <div className="fixed top-16 left-1/2 -translate-x-1/2 z-40">
       <div className="bg-[#1a1a1a]/90 backdrop-blur-sm border border-[#262626] rounded-full px-4 py-2 flex items-center gap-2">
         <div className="w-3 h-3 border-2 border-[#EA580C] border-t-transparent rounded-full animate-spin" />
         <span className="text-sm text-[#a3a3a3]">
           Building deep memory...
         </span>
       </div>
     </div>
   )}
   ```

   Remove the old conditions that check `memoryProgress < 100` and `memoryStatus === 'loading' || memoryStatus === 'processing'`. Replace with a single check on `memoryStatus === 'building'`.

6. **V2 silent upgrade** (IMP-05) -- This happens automatically because the chat API reads sections from the database at request time. When the full pass completes and writes v2 sections, the next chat message will use v2. No client-side code change needed for the upgrade itself. The only UX signal is the memory progress indicator disappearing.

The full rewritten polling effect:
```typescript
useEffect(() => {
  const controller = new AbortController();
  const shouldPoll = { current: true };

  const checkMemoryStatus = async () => {
    if (!shouldPoll.current) return;

    try {
      const res = await fetch('/api/memory/status', {
        signal: controller.signal
      });
      if (controller.signal.aborted) return;
      if (!res.ok) return;

      const data = await res.json();

      // Gate: no soulprint and not ready -> redirect to import
      if (!data.hasSoulprint && (data.status === 'none' || data.status === 'processing')) {
        router.push('/import');
        return;
      }

      // Gate: failed import
      if (data.status === 'failed' || data.failed) {
        setMemoryStatus('failed');
        setImportError(data.import_error || data.importError || 'Import processing failed. Please try again.');
        return;
      }

      // Has soulprint (quick_ready or complete) -- check full pass status
      const fps = data.fullPassStatus || 'pending';
      if (fps === 'complete') {
        setMemoryStatus('ready');
        shouldPoll.current = false; // Stop polling
      } else if (fps === 'failed') {
        // Full pass failure is non-fatal -- user can still chat with v1 sections
        setMemoryStatus('ready');
        shouldPoll.current = false;
        console.warn('[Chat] Full pass failed (non-fatal):', data.fullPassError);
      } else {
        // pending or processing
        setMemoryStatus('building');
      }
    } catch (err) {
      if (err instanceof Error && err.name === 'AbortError') return;
      console.error('Memory status check failed:', err);
    }
  };

  checkMemoryStatus();
  const interval = setInterval(checkMemoryStatus, 5000);

  return () => {
    controller.abort();
    shouldPoll.current = false;
    clearInterval(interval);
  };
}, [router]);
```
  </action>
  <verify>
Run `npm run build` -- builds successfully.
Grep for "memoryProgress" in chat/page.tsx to confirm it's either removed or no longer drives UI.
Grep for "fullPassStatus" in chat/page.tsx to confirm it's consumed from the API response.
  </verify>
  <done>
Chat page properly gates on import_status (redirects to /import if not ready). Memory progress indicator shows "Building deep memory..." based on full_pass_status. Indicator disappears when full pass completes. Polling stops when fully complete. V2 sections upgrade silently on next message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove sendSoulprintReadyEmail and clean up email module</name>
  <files>lib/email/send.ts</files>
  <action>
Remove the entire `sendSoulprintReadyEmail` function from `lib/email/send.ts`. Research confirmed it is not called anywhere in the codebase (and the RLM service doesn't send email either).

Since `sendSoulprintReadyEmail` is the ONLY export in `lib/email/send.ts`, check if the file is imported anywhere:
- Grep for `from '@/lib/email/send'` or `from '../email/send'` in the codebase
- If no imports exist, the file can be emptied to just the Resend initialization (keep it for future use -- waitlist email may use it)
- If imports exist, remove only the function and update imports

The file should be reduced to:
```typescript
/**
 * Email sending utility using Resend
 *
 * sendSoulprintReadyEmail removed (v1.2) -- users now go directly to chat
 * after quick pass, no email needed.
 */

import { Resend } from 'resend';

const resend = process.env.RESEND_API_KEY
  ? new Resend(process.env.RESEND_API_KEY)
  : null;

const FROM_EMAIL = 'SoulPrint <noreply@soulprint.so>';

// Resend client and FROM_EMAIL kept for future email features (waitlist, etc.)
export { resend, FROM_EMAIL };
```

Also verify EMAIL-02 (keep waitlist confirmation email unchanged) by searching for any other email-sending code in the codebase. The waitlist email is likely handled by Supabase Auth or a separate endpoint -- do NOT modify it.
  </action>
  <verify>
Run `npm run build` -- builds successfully.
Grep for `sendSoulprintReadyEmail` across the entire codebase -- should return 0 results in .ts/.tsx files (only planning docs may reference it).
  </verify>
  <done>
sendSoulprintReadyEmail function removed from codebase (EMAIL-01). Email module preserved with Resend client for future use. Waitlist email unchanged (EMAIL-02).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes
2. No references to `sendSoulprintReadyEmail` in source code
3. Chat page shows "Building deep memory..." when full_pass_status is pending/processing
4. Chat page hides progress indicator when full_pass_status is complete
5. Chat page redirects to /import when import_status is 'none' or 'processing'
6. Chat page allows access when import_status is 'quick_ready' or 'complete'
</verification>

<success_criteria>
- Memory progress indicator shows while background processing runs (IMP-04)
- Sections silently upgrade to v2 after full pass completes (IMP-05 -- happens automatically, indicator disappears)
- MEMORY section builds in background after chat opens (IMP-03)
- No sendSoulprintReadyEmail function exists (EMAIL-01)
- Waitlist email is unchanged (EMAIL-02)
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-integration-ux/03-03-SUMMARY.md`
</output>
