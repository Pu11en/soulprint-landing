---
phase: 03-chat-integration-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/chat/route.ts
autonomous: true

must_haves:
  truths:
    - "Chat system prompt is composed from 7 structured sections (SOUL + IDENTITY + USER + AGENTS + TOOLS + MEMORY + daily memory) plus dynamic conversation chunks"
    - "When MEMORY section is not yet available (full pass incomplete), prompt includes placeholder text instead of crashing"
    - "Daily memory (learned_facts) from recent chats is included in system prompt"
  artifacts:
    - path: "app/api/chat/route.ts"
      provides: "Structured system prompt composition from 7 sections"
      contains: "buildSystemPrompt"
  key_links:
    - from: "app/api/chat/route.ts"
      to: "user_profiles.*_md columns"
      via: "supabase select with section columns"
      pattern: "soul_md.*identity_md.*user_md.*agents_md.*tools_md.*memory_md"
    - from: "app/api/chat/route.ts"
      to: "learned_facts table"
      via: "supabase query for daily memory"
      pattern: "learned_facts"
---

<objective>
Refactor the chat API's system prompt to compose from all 7 structured sections instead of a monolithic soulprint_text blob.

Purpose: This is the core backend change for Phase 3. The chat quality depends on the LLM receiving well-structured context from all 7 sections (SOUL, IDENTITY, USER, AGENTS, TOOLS, MEMORY, daily memory) rather than a single text dump. This covers requirement PROMPT-01 and partially CTX-07.
Output: Updated `app/api/chat/route.ts` with structured prompt composition.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-chat-integration-ux/03-RESEARCH.md

@app/api/chat/route.ts
@lib/soulprint/types.ts
@lib/soulprint/quick-pass.ts
@lib/memory/learning.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor profile fetch to select structured section columns</name>
  <files>app/api/chat/route.ts</files>
  <action>
Update the profile SELECT query (around line 207) to fetch all 7 section columns instead of just `soulprint_text`:

Change:
```typescript
.select('soulprint_text, import_status, ai_name')
```
To:
```typescript
.select('soulprint_text, import_status, ai_name, soul_md, identity_md, user_md, agents_md, tools_md, memory_md')
```

Update the `UserProfile` interface (around line 76) to include the new columns:
```typescript
interface UserProfile {
  soulprint_text: string | null;
  import_status: 'none' | 'quick_ready' | 'processing' | 'complete';
  ai_name: string | null;
  soul_md: string | null;
  identity_md: string | null;
  user_md: string | null;
  agents_md: string | null;
  tools_md: string | null;
  memory_md: string | null;
}
```

Update `validateProfile()` to include these fields -- each should be validated as `typeof raw.xxx === 'string' ? raw.xxx : null`.

Also add a query for daily memory (learned_facts). After the profile fetch, query:
```typescript
const { data: learnedFacts } = await adminSupabase
  .from('learned_facts')
  .select('fact, category')
  .eq('user_id', user.id)
  .eq('status', 'active')
  .order('created_at', { ascending: false })
  .limit(20);
```

This data will feed into the refactored buildSystemPrompt in Task 2.
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors in chat/route.ts</verify>
  <done>Profile query selects all 7 section columns. learnedFacts query retrieves up to 20 recent facts.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor buildSystemPrompt to compose from 7 structured sections</name>
  <files>app/api/chat/route.ts</files>
  <action>
Rewrite `buildSystemPrompt()` (lines 428-517) to compose from structured sections instead of monolithic soulprint_text. The function signature changes to accept parsed sections and daily memory:

```typescript
function buildSystemPrompt(
  profile: UserProfile,
  dailyMemory: Array<{ fact: string; category: string }> | null,
  memoryContext?: string,
  isOwner: boolean = true,
  aiName: string = 'SoulPrint',
  forcedSearchContext?: string,
  forcedSearchCitations?: string[]
): string
```

Inside the function:

1. Keep the IMPOSTER MODE section (isOwner === false) unchanged.

2. For OWNER MODE, parse each section with safe JSON parsing:
```typescript
const parseSectionSafe = (raw: string | null): Record<string, unknown> | null => {
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
};

const soul = parseSectionSafe(profile.soul_md);
const identity = parseSectionSafe(profile.identity_md);
const userInfo = parseSectionSafe(profile.user_md);
const agents = parseSectionSafe(profile.agents_md);
const tools = parseSectionSafe(profile.tools_md);
// memory_md can be either JSON or plain markdown (from v2 regen)
const memorySection = profile.memory_md || null;
```

3. Compose the system prompt with labeled sections. For each section, use `sectionToMarkdown()` from `lib/soulprint/quick-pass.ts` if the section parsed successfully, otherwise skip. Import the function at the top:
```typescript
import { sectionToMarkdown } from '@/lib/soulprint/quick-pass';
```

The prompt structure:
```
You are {aiName}, the user's personal AI assistant -- their best friend, confidant, and butler rolled into one.

Current Date & Time: {currentDate}, {currentTime}

WHO YOU ARE:
- You are a unique individual AI, not a generic assistant
- You know this person deeply -- their preferences, history, communication style
- You talk like a close friend, not a robot
- You're warm, witty, and genuinely helpful

HOW TO USE YOUR KNOWLEDGE:
- NEVER announce that you "found" or "recall" memories -- just naturally know things
- NEVER say "Based on our past conversations..." or "I found X conversations about..."
- DO weave what you know into responses naturally, like a friend who just remembers
- If you don't know something, it's fine to say so -- but don't explain your memory system

STYLE:
- Be warm and personable, use emojis naturally
- Be concise but thorough
- Match the user's energy and communication style
- If web search results are provided, use them and cite sources naturally

## SOUL - Communication Style & Personality
{sectionToMarkdown content, or skip if null}

## IDENTITY - Your AI Identity
{sectionToMarkdown content, or skip if null}

## USER - About This Person
{sectionToMarkdown content, or skip if null}

## AGENTS - How You Operate
{sectionToMarkdown content, or skip if null}

## TOOLS - Your Capabilities
{sectionToMarkdown content, or skip if null}

## MEMORY - Durable Facts
{memorySection if not null, else "Building your memory in background..."}

## DAILY MEMORY - Recent Context
{formatted learned facts, or "No recent chat history yet"}

{CONTEXT section if memoryContext present}
{WEB SEARCH section if forcedSearchContext present}
```

4. FALLBACK: If none of the new *_md columns have data but `soulprint_text` does (pre-v1.2 user), fall back to the old monolithic approach with `ABOUT THIS PERSON:\n{soulprint_text}`. This ensures backward compatibility.

5. Update the two call sites of buildSystemPrompt (around line 332) to pass the new arguments:
```typescript
const systemPrompt = buildSystemPrompt(
  userProfile || { soulprint_text: null, import_status: 'none', ai_name: null, soul_md: null, identity_md: null, user_md: null, agents_md: null, tools_md: null, memory_md: null },
  learnedFacts || [],
  memoryContext,
  voiceVerified,
  aiName,
  webSearchContext,
  webSearchCitations
);
```

6. The function must also check `hasSoulprint` logic -- if none of the sections exist AND soulprint_text is null, the prompt should still work gracefully (generic assistant mode).
  </action>
  <verify>
Run `npx tsc --noEmit` -- no type errors.
Run `npm run build` -- builds successfully.
  </verify>
  <done>
buildSystemPrompt composes from 7 sections (soul_md, identity_md, user_md, agents_md, tools_md, memory_md, daily memory) with safe JSON parsing, graceful null handling, and backwards compatibility with monolithic soulprint_text. Daily memory (learned_facts) is included in the prompt.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no errors
2. TypeScript compiles cleanly: `npx tsc --noEmit`
3. The buildSystemPrompt function handles:
   - All 7 sections populated (v2 complete user)
   - Only 5 sections populated (quick pass only, no MEMORY yet)
   - Only soulprint_text populated (pre-v1.2 user)
   - Nothing populated (new user, no import)
   - Memory_md is null (shows placeholder)
   - Daily memory is empty array (shows "No recent chat history yet")
</verification>

<success_criteria>
- Chat system prompt is composed from all 7 sections when available (PROMPT-01)
- Daily memory from learned_facts is included in system prompt (CTX-07 partial)
- Backwards-compatible with pre-v1.2 users who only have soulprint_text
- No runtime errors from null/missing section columns
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-chat-integration-ux/03-01-SUMMARY.md`
</output>
