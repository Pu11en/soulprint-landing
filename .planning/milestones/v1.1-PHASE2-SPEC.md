# v1.1 Phase 2: Hardening — Spec

**Status:** READY TO EXECUTE
**Created:** 2026-02-04
**Goal:** Make SoulPrint work reliably for real users

---

## Problem Statement

Phase 1 (MVP) shipped but has reliability issues:
- Users can't reset their data without admin access
- Errors fail silently or show cryptic messages
- No visibility into processing progress
- Large files cause failures

---

## Success Criteria

- [ ] Any user can reset their own import data
- [ ] All errors show user-friendly messages
- [ ] Progress visible at each stage (upload → process → embed → ready)
- [ ] 100% of imports under 500MB succeed

---

## Sprint 1: Critical Fixes

### Task 1.1: User Self-Reset

**Current:** Only admin emails can reset
**Target:** Any logged-in user can reset their own data

**Implementation:**
```typescript
// NEW: app/api/user/reset/route.ts
// DELETE /api/user/reset - resets current user's data

export async function DELETE(request: Request) {
  const supabase = await createServerClient();
  const { data: { user } } = await supabase.auth.getUser();
  
  if (!user) return unauthorized();
  
  // Delete user's data (same logic as admin reset)
  await deleteUserData(user.id);
  
  return NextResponse.json({ success: true });
}
```

**UI Change:**
```typescript
// app/import/page.tsx - add button for any user
<Button onClick={handleSelfReset}>
  Reset & Start Over
</Button>
```

**Files to modify:**
- [ ] Create `app/api/user/reset/route.ts`
- [ ] Update `app/import/page.tsx` - use new endpoint

**Estimate:** 30 min

---

### Task 1.2: Surface Error Messages

**Current:** Errors logged to console, not shown to users
**Target:** All errors display user-friendly messages

**Error States to Handle:**

| Stage | Error | User Message |
|-------|-------|--------------|
| Upload | File too large | "File is too large. Please try a smaller export (under 500MB)." |
| Upload | Invalid format | "This doesn't look like a ChatGPT export. Please export from ChatGPT and try again." |
| Processing | Parse failed | "Couldn't read your export. Please re-export from ChatGPT." |
| Processing | Stuck >10min | "Import is taking longer than expected. [Retry]" |
| Embedding | Bedrock error | "AI processing temporarily unavailable. We'll retry automatically." |
| Chat | RLM down | "Memory search unavailable. Chat will work but without memories." |

**Files to modify:**
- [ ] `app/import/page.tsx` - error display component
- [ ] `app/chat/page.tsx` - error display component
- [ ] `app/api/import/process-server/route.ts` - return clear error codes
- [ ] `app/api/chat/route.ts` - return clear error codes

**Estimate:** 1 hour

---

### Task 1.3: Add Admin Email (Quick Fix)

**Current:** Only 2 emails in admin list
**Target:** Add Drew's Google account

**Implementation:**
```typescript
// app/api/admin/reset-user/route.ts line 15
const ADMIN_EMAILS = [
  'drew@archeforge.com',
  'drewspatterson@gmail.com',
  // Add Drew's kidquick360 Google email here
];
```

**Estimate:** 5 min (need email from Drew)

---

## Sprint 2: Progress UX

### Task 2.1: Upload Progress Bar

**Current:** No feedback during upload
**Target:** Show upload percentage

**Implementation:**
```typescript
// app/import/page.tsx
const [uploadProgress, setUploadProgress] = useState(0);

// Use XHR or fetch with progress event
xhr.upload.onprogress = (e) => {
  setUploadProgress(Math.round((e.loaded / e.total) * 100));
};
```

**Estimate:** 30 min

---

### Task 2.2: Processing Stages

**Current:** Generic "Processing..." message
**Target:** Show specific stage

**Stages:**
1. "Uploading your export..."
2. "Extracting conversations..."
3. "Analyzing patterns..." 
4. "Building your memory..."
5. "Generating your SoulPrint..."
6. "Ready!"

**Implementation:**
- Add `import_stage` column to `user_profiles`
- Update stage during processing
- Poll and display in UI

**Estimate:** 1 hour

---

### Task 2.3: Embedding Progress

**Current:** Shows "processing" with no detail
**Target:** Show X/Y chunks embedded

**Implementation:**
- `user_profiles` already has `total_chunks`
- Add `embedded_chunks` counter
- Display: "Embedding memories: 234/1,500"

**Estimate:** 45 min

---

## Sprint 3: Edge Cases

### Task 3.1: Large File Handling

**Current:** Vercel hits 500MB memory limit
**Target:** Handle files up to 2GB

**Approach:** Stream-based processing
- Use streaming upload to Supabase Storage
- Process ZIP in chunks server-side
- Don't load entire file in memory

**Estimate:** 3 hours

---

### Task 3.2: Retry After Failure

**Current:** No way to resume
**Target:** Checkpoint system

**Approach:**
- Store last successful stage
- Allow retry from that point
- Clean up partial data if needed

**Estimate:** 2 hours

---

## Test Plan

### Sprint 1 Tests
- [ ] User can reset their own data (not admin)
- [ ] Invalid ZIP shows clear error
- [ ] Network error shows retry option
- [ ] Admin reset still works

### Sprint 2 Tests
- [ ] Upload shows percentage
- [ ] Processing shows current stage
- [ ] Embedding shows progress count
- [ ] All stages visible in UI

### Sprint 3 Tests
- [ ] 1GB file processes successfully
- [ ] Failed import can be retried
- [ ] Partial progress preserved

---

## Rollback Plan

If issues found in production:
1. Keep admin reset as fallback
2. Feature flag new user reset
3. Can disable progress UI without breaking function

---

*Spec ready for execution. Start with Sprint 1.*
