# LLM Regression Tests
#
# Runs LLM-as-judge regression tests on prompt changes.
# Validates that prompt variants meet minimum quality thresholds for:
# - personality_consistency (0.70)
# - factuality (0.75)
# - tone_matching (0.70)
#
# Requires repository secrets:
# - OPIK_API_KEY: Opik API key for experiment tracking
# - AWS_ACCESS_KEY_ID: AWS credentials for Bedrock Haiku 4.5
# - AWS_SECRET_ACCESS_KEY: AWS credentials for Bedrock Haiku 4.5
#
# Creates Opik experiments tracked in the dashboard.
# Exit code 0 = all metrics pass, 1 = regression detected.

name: LLM Regression Tests

on:
  pull_request:
    paths:
      - 'lib/soulprint/prompt-builder.ts'
      - 'lib/soulprint/prompt-helpers.ts'
      - 'lib/soulprint/emotional-intelligence.ts'
      - 'lib/evaluation/judges.ts'
      - 'lib/evaluation/quality-judges.ts'
      - 'lib/evaluation/quality-scoring.ts'
      - 'rlm-service/prompt_builder.py'

  # Allow manual triggering for ad-hoc regression checks
  workflow_dispatch:
    inputs:
      dataset:
        description: 'Opik dataset name'
        required: true
        type: string
      variant:
        description: 'Prompt variant (v1, v2-natural-voice)'
        required: true
        default: 'v2-natural-voice'
        type: choice
        options:
          - v1
          - v2-natural-voice
      samples:
        description: 'Number of samples (min 20)'
        required: false
        default: '20'
        type: string

jobs:
  regression-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run prompt regression tests
        env:
          OPIK_API_KEY: ${{ secrets.OPIK_API_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          DATASET: ${{ github.event.inputs.dataset || 'chat-eval-regression' }}
          VARIANT: ${{ github.event.inputs.variant || 'v2-natural-voice' }}
          SAMPLES: ${{ github.event.inputs.samples || '20' }}
        run: npx tsx scripts/regression-test.ts --dataset $DATASET --variant $VARIANT --samples $SAMPLES

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-results
          path: |
            *.log
            regression-*.json
          if-no-files-found: ignore
